#!/usr/bin/env python3
# /// script
# dependencies = [
#   "yfinance>=0.2.28",
#   "rich>=13.0.0",
# ]
# ///

import sys
import yfinance as yf
from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from datetime import datetime, timedelta

console = Console()

def get_price(symbol):
    """Get current price for a symbol."""
    try:
        ticker = yf.Ticker(symbol)
        info = ticker.info
        price = info.get('currentPrice') or info.get('regularMarketPrice')
        change = info.get('regularMarketChange')
        change_pct = info.get('regularMarketChangePercent')
        
        if price:
            console.print(f"\n[bold cyan]{symbol}[/bold cyan]")
            console.print(f"Price: [bold green]${price:.2f}[/bold green]" if change and change >= 0 else f"Price: [bold red]${price:.2f}[/bold red]")
            if change is not None and change_pct is not None:
                color = "green" if change >= 0 else "red"
                console.print(f"Change: [{color}]{change:+.2f} ({change_pct:+.2f}%)[/{color}]")
        else:
            console.print(f"[red]No price data for {symbol}[/red]")
    except Exception as e:
        console.print(f"[red]Error: {e}[/red]")

def get_quote(symbol):
    """Get detailed quote."""
    try:
        ticker = yf.Ticker(symbol)
        info = ticker.info
        
        table = Table(title=f"{symbol} Quote", show_header=False)
        table.add_column("Field", style="cyan")
        table.add_column("Value", style="white")
        
        fields = [
            ('Name', info.get('longName')),
            ('Price', f"${info.get('currentPrice', 'N/A')}"),
            ('Market Cap', f"${info.get('marketCap', 0)/1e9:.2f}B" if info.get('marketCap') else 'N/A'),
            ('Volume', f"{info.get('volume', 0):,}"),
            ('52W High', f"${info.get('fiftyTwoWeekHigh', 'N/A')}"),
            ('52W Low', f"${info.get('fiftyTwoWeekLow', 'N/A')}"),
            ('PE Ratio', info.get('trailingPE', 'N/A')),
            ('EPS', info.get('trailingEps', 'N/A')),
        ]
        
        for field, value in fields:
            table.add_row(field, str(value))
        
        console.print(table)
    except Exception as e:
        console.print(f"[red]Error: {e}[/red]")

def get_fundamentals(symbol):
    """Get fundamental data."""
    try:
        ticker = yf.Ticker(symbol)
        info = ticker.info
        
        table = Table(title=f"{symbol} Fundamentals", show_header=False)
        table.add_column("Metric", style="cyan")
        table.add_column("Value", style="white")
        
        metrics = [
            ('Market Cap', f"${info.get('marketCap', 0)/1e9:.2f}B" if info.get('marketCap') else 'N/A'),
            ('Enterprise Value', f"${info.get('enterpriseValue', 0)/1e9:.2f}B" if info.get('enterpriseValue') else 'N/A'),
            ('Trailing PE', info.get('trailingPE', 'N/A')),
            ('Forward PE', info.get('forwardPE', 'N/A')),
            ('PEG Ratio', info.get('pegRatio', 'N/A')),
            ('Price/Book', info.get('priceToBook', 'N/A')),
            ('Price/Sales', info.get('priceToSalesTrailing12Months', 'N/A')),
            ('Enterprise/Revenue', info.get('enterpriseToRevenue', 'N/A')),
            ('Enterprise/EBITDA', info.get('enterpriseToEbitda', 'N/A')),
            ('Revenue', f"${info.get('totalRevenue', 0)/1e9:.2f}B" if info.get('totalRevenue') else 'N/A'),
            ('Revenue Growth', f"{info.get('revenueGrowth', 0)*100:.2f}%" if info.get('revenueGrowth') else 'N/A'),
            ('Profit Margin', f"{info.get('profitMargins', 0)*100:.2f}%" if info.get('profitMargins') else 'N/A'),
            ('ROE', f"{info.get('returnOnEquity', 0)*100:.2f}%" if info.get('returnOnEquity') else 'N/A'),
            ('ROA', f"{info.get('returnOnAssets', 0)*100:.2f}%" if info.get('returnOnAssets') else 'N/A'),
            ('Target Price', f"${info.get('targetMeanPrice', 'N/A')}"),
            ('Analysts', info.get('numberOfAnalystOpinions', 'N/A')),
        ]
        
        for metric, value in metrics:
            table.add_row(metric, str(value))
        
        console.print(table)
    except Exception as e:
        console.print(f"[red]Error: {e}[/red]")

def main():
    if len(sys.argv) < 2:
        console.print(Panel("""
[bold]Yahoo Finance CLI[/bold]

Usage: yf <command> <symbol>

Commands:
  yf <symbol>              Quick price check
  yf price <symbol>        Same as above
  yf quote <symbol>        Detailed quote
  yf fundamentals <symbol> Valuation metrics

Examples:
  yf AAPL
  yf quote MSFT
  yf fundamentals NVDA
        """, title="yf"))
        return
    
    cmd = sys.argv[1].lower()
    
    # If no command specified, treat as price check
    if cmd not in ['price', 'quote', 'fundamentals']:
        symbol = sys.argv[1].upper()
        get_price(symbol)
    else:
        if len(sys.argv) < 3:
            console.print("[red]Error: Symbol required[/red]")
            return
        symbol = sys.argv[2].upper()
        
        if cmd == 'price':
            get_price(symbol)
        elif cmd == 'quote':
            get_quote(symbol)
        elif cmd == 'fundamentals':
            get_fundamentals(symbol)

if __name__ == '__main__':
    main()
