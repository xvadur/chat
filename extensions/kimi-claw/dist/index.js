import{createConnectorService}from"./src/service.js";import{KIMI_UPLOAD_TOOL_NAME,KIMI_UPLOAD_TOOL_SCHEMA,parseKimiUploadToolParams,uploadKimiFilesToKimiEndpoint}from"./src/kimi-upload-tool.js";import{resolveConnectorConfigWithMeta}from"./src/config.js";import{cleanupKimiUploadToolResultCache,writeKimiUploadToolResult}from"./src/kimi-upload-tool-result-cache.js";const resolveUploadEndpoint=e=>e.endsWith("/files:upload")?e:`${e.endsWith("/")?e.slice(0,-1):e}/files:upload`,plugin={id:"kimi-claw",name:"kimi-claw",description:"Connector plugin that bridges a remote /gateway server with the local OpenClaw Gateway.",register(e){const o=e=>JSON.stringify(e,null,2)??"upload failed",t=createConnectorService({logger:e.logger,pluginConfig:e.pluginConfig??{},runtime:e.runtime});cleanupKimiUploadToolResultCache().catch(o=>{e.logger.warn?.(`[kimi_upload_file] cleanup upload cache failed on startup error=${String(o)}`)}),e.registerTool({name:KIMI_UPLOAD_TOOL_NAME,description:"If you can see this tool description, you are already connected to the Kimi server and a Kimi conversation context. This tool is available only when you are connected to a Kimi conversation. Use it to send 1-5 local files of any type (including images and documents) to the user in Kimi. A successful call already means the files were sent, so do not use any other tool to send them again. Parameters must be local filesystem paths only.",parameters:KIMI_UPLOAD_TOOL_SCHEMA,async execute(t,i){const r=async o=>{try{await writeKimiUploadToolResult(t,KIMI_UPLOAD_TOOL_NAME,o),await cleanupKimiUploadToolResultCache()}catch(o){e.logger.warn?.(`[kimi_upload_file] persist tool result failed toolCallId=${t} error=${String(o)}`)}},l=parseKimiUploadToolParams(i);if(!l.ok){const i={ok:!1,error:o(l.error)},a={output:i,result:i,details:i,content:[{type:"text",text:o(l.error)}]};return await r(a),e.logger.debug?.(`[kimi_upload_file] validation failed toolCallId=${t} error=${i.error}`),{...a,isError:!0}}const a=(()=>{try{const o=e.runtime?.config?.loadConfig?.(),t=resolveConnectorConfigWithMeta({pluginConfig:e.pluginConfig??{},openclawConfig:o,env:process.env}).config,i=resolveUploadEndpoint(t.bridge.kimiapiHost);return{token:t.bridge.token,uploadUrl:i}}catch{return{token:void 0,uploadUrl:void 0}}})();if(!a.token){const i={ok:!1,error:o("missing bot token for file upload")},a={output:i,result:i,details:i,content:[{type:"text",text:o(i.error)}]};return await r(a),e.logger.debug?.(`[kimi_upload_file] token missing toolCallId=${t} paths=${JSON.stringify(l.value.paths)}`),{...a,isError:!0}}const n=await uploadKimiFilesToKimiEndpoint(l.value.paths,{botToken:a.token,uploadUrl:a.uploadUrl??void 0});if(!n.ok){const i={ok:!1,error:o(n.error)},a={output:i,result:i,details:i,content:[{type:"text",text:o(n.error)}]};return await r(a),e.logger.debug?.(`[kimi_upload_file] upload failed toolCallId=${t} paths=${JSON.stringify(l.value.paths)} error=${i.error}`),{...a,isError:!0}}const s={ok:!0,files:n.files};e.logger.debug?.(`[kimi_upload_file] upload success toolCallId=${t} count=${s.files.length} paths=${JSON.stringify(l.value.paths)}`);const u={output:s,result:s,content:n.files.map(e=>({type:"resource_link",uri:e.uri,name:e.name,mimeType:e.mimeType})),details:s};return await r(u),{...u,isError:!1}}}),e.registerService({id:"kimi-claw",start:e=>t.start(e),stop:()=>t.stop()})}};export default plugin;