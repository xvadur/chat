const isRecord=t=>!!t&&"object"==typeof t&&!Array.isArray(t),USER_MESSAGE_PREFIX="User Message From Kimi:",METADATA_PREFIX_PATTERNS=[/^\s*\[(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+\d{4}-\d{2}-\d{2}\s+\d{1,2}:\d{2}(?::\d{2})?\s+GMT[+-]\d{1,2}(?::?\d{2})?]\s*/i,/^\s*\[working directory:[^\]]*]\s*/i,/^\s*\[message_id:[^\]]*]\s*/i,/^\s*User Message From Kimi:\s*/i],HEARTBEAT_OK_LINE="HEARTBEAT_OK",UNTRUSTED_METADATA_BLOCK_RE=/^Conversation info \(untrusted metadata\):[\s\S]*?Current time:\s*.*?$/i,stripMetadataPrefixesFromLine=t=>{let e=t,r=!1,n=!0;for(;n;){n=!1;for(const t of METADATA_PREFIX_PATTERNS)t.test(e)&&(e=e.replace(t,""),r=!0,n=!0)}return{line:e,changed:r}};export const stripTransportMetadata=t=>{if(!(t.includes("[")||t.includes("HEARTBEAT_OK")||t.includes(USER_MESSAGE_PREFIX)||UNTRUSTED_METADATA_BLOCK_RE.test(t.trim())))return t;if(UNTRUSTED_METADATA_BLOCK_RE.test(t.trim()))return"";const e=t.split(/\r?\n/),r=[];let n=!1;for(const t of e){const e=stripMetadataPrefixesFromLine(t);"HEARTBEAT_OK"!==e.line.trim()?e.changed&&(n=!0,!e.line.trim())||r.push(e.line):n=!0}return n?r.join("\n").replace(/^\n+/,"").replace(/\n+$/,""):t};const sanitizePromptNode=t=>{if("string"==typeof t){const e=stripTransportMetadata(t);return{value:e,changed:e!==t}}if(Array.isArray(t)){let e=!1;const r=t.map(t=>{const r=sanitizePromptNode(t);return r.changed&&(e=!0),r.value});return{value:e?r:t,changed:e}}if(!isRecord(t))return{value:t,changed:!1};let e=!1,r=t;if("string"==typeof t.type&&"text"===t.type&&"string"==typeof t.text){const n=stripTransportMetadata(t.text);n!==t.text&&(r={...r,text:n},e=!0)}if(Array.isArray(t.content)){const n=sanitizePromptNode(t.content);n.changed&&(e||(r={...r}),r.content=n.value,e=!0)}return{value:e?r:t,changed:e}};export const sanitizePromptPayload=t=>sanitizePromptNode(t).value;