import{appendFileSync,mkdirSync,renameSync,rmSync,statSync}from"node:fs";import path from"node:path";export const DEFAULT_LOG_ROLLING_MAX_BYTES=524288e3;export const DEFAULT_LOG_ROLLING_MAX_BACKUPS=1;const normalizePositiveInteger=(e,t)=>{if("number"!=typeof e||!Number.isFinite(e))return t;const r=Math.trunc(e);return r<0?t:r},readFileSize=e=>{try{return statSync(e).size}catch(e){const t=e;if("ENOENT"===t?.code)return 0;throw e}},rotateLogFile=(e,t)=>{if(t<=0)rmSync(e,{force:!0});else for(let r=t;r>=1;r-=1){const t=1===r?e:`${e}.${r-1}`,n=`${e}.${r}`;rmSync(n,{force:!0});try{statSync(t)}catch(e){const t=e;if("ENOENT"===t?.code)continue;throw e}renameSync(t,n)}};export const createRollingJsonlWriter=e=>{const t=e.filePath.trim();if(!t)return e=>{};const r=normalizePositiveInteger(e.maxBytes,524288e3),n=normalizePositiveInteger(e.maxBackups,1),o=path.resolve(t),i=e.contextLabel.trim()||"log";try{mkdirSync(path.dirname(o),{recursive:!0})}catch(t){e.logger.warn(`[${i}] failed to create log directory for ${o}: ${String(t)}`)}let c=!1,a=!1;return t=>{const l=`${JSON.stringify(t)}\n`,s=Buffer.byteLength(l,"utf-8");try{readFileSize(o)+s>r&&rotateLogFile(o,n),appendFileSync(o,l,"utf-8"),s>r&&!a&&(a=!0,e.logger.warn(`[${i}] single JSONL row is larger than rolling limit maxBytes=${r} file=${o}`))}catch(t){c||(c=!0,e.logger.warn(`[${i}] failed to append rolling log file ${o}: ${String(t)}`))}}};