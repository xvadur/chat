import crypto from"node:crypto";import fs from"node:fs";import path from"node:path";import{homedir}from"node:os";const DEFAULT_IDENTITY_PATH=path.join(homedir(),".openclaw","plugins","kimi-claw","device.json"),ED25519_SPKI_PREFIX=Buffer.from("302a300506032b6570032100","hex");function base64UrlEncode(e){return e.toString("base64").replaceAll("+","-").replaceAll("/","_").replace(/=+$/g,"")}function derivePublicKeyRaw(e){const t=crypto.createPublicKey(e).export({type:"spki",format:"der"});return t.length===ED25519_SPKI_PREFIX.length+32&&t.subarray(0,ED25519_SPKI_PREFIX.length).equals(ED25519_SPKI_PREFIX)?t.subarray(ED25519_SPKI_PREFIX.length):t}function fingerprintPublicKey(e){const t=derivePublicKeyRaw(e);return crypto.createHash("sha256").update(t).digest("hex")}function generateIdentity(){const{publicKey:e,privateKey:t}=crypto.generateKeyPairSync("ed25519"),i=e.export({type:"spki",format:"pem"}).toString(),n=t.export({type:"pkcs8",format:"pem"}).toString();return{deviceId:fingerprintPublicKey(i),publicKeyPem:i,privateKeyPem:n}}export function loadOrCreateDeviceIdentity(e=DEFAULT_IDENTITY_PATH){try{if(fs.existsSync(e)){const t=fs.readFileSync(e,"utf8"),i=JSON.parse(t);if(1===i?.version&&"string"==typeof i.deviceId&&"string"==typeof i.publicKeyPem&&"string"==typeof i.privateKeyPem){const t=fingerprintPublicKey(i.publicKeyPem);if(t&&t!==i.deviceId){const n={...i,deviceId:t};return fs.mkdirSync(path.dirname(e),{recursive:!0}),fs.writeFileSync(e,`${JSON.stringify(n,null,2)}\n`,{mode:384}),{deviceId:t,publicKeyPem:i.publicKeyPem,privateKeyPem:i.privateKeyPem}}return{deviceId:i.deviceId,publicKeyPem:i.publicKeyPem,privateKeyPem:i.privateKeyPem}}}}catch{}const t=generateIdentity();fs.mkdirSync(path.dirname(e),{recursive:!0});const i={version:1,deviceId:t.deviceId,publicKeyPem:t.publicKeyPem,privateKeyPem:t.privateKeyPem,createdAtMs:Date.now()};fs.writeFileSync(e,`${JSON.stringify(i,null,2)}\n`,{mode:384});try{fs.chmodSync(e,384)}catch{}return t}function signPayload(e,t){const i=crypto.createPrivateKey(e);return base64UrlEncode(crypto.sign(null,Buffer.from(t,"utf8"),i))}function buildAuthPayload(e){const t=e.nonce?"v2":"v1",i=e.scopes.join(","),n=e.token??"",r=[t,e.deviceId,e.clientId,e.clientMode,e.role,i,String(e.signedAtMs),n];return"v2"===t&&r.push(e.nonce??""),r.join("|")}export function buildDeviceAuthField(e){const t=Date.now(),i=buildAuthPayload({deviceId:e.identity.deviceId,clientId:e.clientId,clientMode:e.clientMode,role:e.role,scopes:e.scopes,signedAtMs:t,token:e.token,nonce:e.nonce}),n=signPayload(e.identity.privateKeyPem,i),r=base64UrlEncode(derivePublicKeyRaw(e.identity.publicKeyPem)),c={id:e.identity.deviceId,publicKey:r,signature:n,signedAt:t};return e.nonce&&(c.nonce=e.nonce),c}