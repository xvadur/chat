import os from"node:os";import path from"node:path";import{AcpGatewayBridgeCore,sanitizeObsMappingPayload}from"./acp-gateway/bridge-core.js";import{AcpGatewayEvents}from"./acp-gateway/gateway-events.js";import{AcpGatewayHistoryReplay}from"./acp-gateway/history-replay.js";import{AcpGatewayKimiFileResolver}from"./acp-gateway/kimi-file-resolver.js";import{AcpGatewayLocalSessionHistory}from"./acp-gateway/local-session-history.js";import{AcpGatewayPromptConverter}from"./acp-gateway/prompt-converter.js";import{AcpGatewaySessionState}from"./acp-gateway/session-state.js";import{AcpGatewayTransport}from"./acp-gateway/transport.js";import{asTrimmedNonEmptyString as asString}from"./utils/text.js";import{isPlainRecord as isRecord}from"./utils/json.js";const DEFAULT_PROMPT_TIMEOUT_MS=18e5,DEFAULT_HISTORY_PENDING_TIMEOUT_MS=15e3;export const DEFAULT_KIMIAPI_HOST="https://www.kimi.com/api-claw";const DEFAULT_KIMI_FILE_RESOLVE_TIMEOUT_MS=1e4,DEFAULT_KIMI_FILE_DOWNLOAD_DIR="./openclaw/kimi/downloads";export class AcpGatewayBridge{state=new AcpGatewaySessionState;historyReplay;gatewayEvents;core;terminalHandler;sendBridgeMessage;logger;constructor(e){this.terminalHandler=e.terminalHandler,this.sendBridgeMessage=e.sendBridgeMessage,this.logger=e.logger;const t=e.logger,a=e.instanceMeta,s=e.agentId,i=e.isGatewayReady,o=e.sendBridgeMessage,r=e.sendGatewayFrame,n=!0===e.forceRealtimeVerbose,l=!0===e.forceReasoningStream,p=!1!==e.forwardThinkingToBridge,d=!1!==e.forwardToolCallsToBridge,m="number"==typeof e.promptTimeoutMs&&Number.isFinite(e.promptTimeoutMs)?Math.trunc(e.promptTimeoutMs):18e5,y=Math.max(0,m),g="number"==typeof e.historyPendingTimeoutMs&&Number.isFinite(e.historyPendingTimeoutMs)?Math.trunc(e.historyPendingTimeoutMs):15e3,c=Math.max(0,g),w=asString(e.kimiapiHost)??DEFAULT_KIMIAPI_HOST,h=asString(e.kimiBotToken),M="number"==typeof e.kimiFileResolveTimeoutMs&&Number.isFinite(e.kimiFileResolveTimeoutMs)?Math.trunc(e.kimiFileResolveTimeoutMs):1e4,T=Math.max(1,M),v=asString(e.kimiFileDownloadDir)??"./openclaw/kimi/downloads",f=path.isAbsolute(v)?v:path.resolve(os.homedir(),v),E=e.fetchImpl??fetch,R=e.writeObsEvent,A=e.traceAll??(()=>{}),G=!0===e.webSshEnabled,u=new AcpGatewayLocalSessionHistory({logger:t,agentId:s}),S=new AcpGatewayTransport({logger:t,state:this.state,sendBridgeMessage:o,writeObsEvent:R,sanitizeObsMappingPayload:sanitizeObsMappingPayload,forwardThinkingToBridge:p,forwardToolCallsToBridge:d});this.historyReplay=new AcpGatewayHistoryReplay({logger:t,state:this.state,isGatewayReady:i,sendGatewayFrame:r,sendSessionUpdate:(e,t,a)=>{S.sendSessionUpdate(e,t,a)},readLocalHistoryMessages:(e,t)=>u.readMessages(e,t),readLocalHistoryEntries:(e,t)=>u.readEntries(e,t),historyPendingTimeoutMs:c});const I=new AcpGatewayPromptConverter({logger:t}),F=new AcpGatewayKimiFileResolver({logger:t,kimiapiHost:w,kimiBotToken:h,kimiFileResolveTimeoutMs:T,kimiFileDownloadDir:f,fetchImpl:E,writeObsEvent:R,traceAll:A});this.core=new AcpGatewayBridgeCore({logger:t,instanceMeta:a,agentId:s,state:this.state,historyReplay:this.historyReplay,promptConverter:I,kimiFileResolver:F,isGatewayReady:i,sendGatewayFrame:r,writeObsEvent:R,forceRealtimeVerbose:n,forceReasoningStream:l,forwardThinkingToBridge:p,forwardToolCallsToBridge:d,promptTimeoutMs:y,sendSessionUpdate:(e,t,a)=>{S.sendSessionUpdate(e,t,a)},sendResult:(e,t,a)=>{S.sendResult(e,t,a)},sendError:(e,t,a,s,i)=>{S.sendError(e,t,a,s,i)},webSshEnabled:G,getCurrentAssistantStream:()=>this.gatewayEvents.getCurrentAssistantStream()}),this.gatewayEvents=new AcpGatewayEvents({logger:t,state:this.state,sendSessionUpdate:(e,t,a,s)=>{S.sendSessionUpdate(e,t,a,s)},completePrompt:(e,t)=>{this.core.completePrompt(e,t)},failPrompt:(e,t,a,s)=>{this.core.failPrompt(e,t,a,s)},replayMissingPromptArtifactsFromLocalHistory:e=>{this.historyReplay.replayMissingPromptArtifactsFromLocalHistory(e)}})}handleBridgeMessage(e){if(isRecord(e)&&"terminal"===e.type){const t=e;if(this.terminalHandler?.handleMessage(e))return;const a="string"==typeof t.terminalId?t.terminalId:"",s="string"==typeof t._clientId?t._clientId:"";return void(a&&s&&this.sendBridgeMessage({type:"terminal",terminalId:a,_clientId:s,payload:{action:"error",code:-32010,message:"shell disabled or terminal not available"}}))}this.core.handleBridgeMessage(e)}handleGatewayFrame(e){"res"!==e.type?"event"!==e.type||"agent"!==e.event?"event"!==e.type||"chat"!==e.event?"event"===e.type&&"cron"===e.event&&this.gatewayEvents.handleGatewayCronEvent(e.payload):this.gatewayEvents.handleGatewayChatEvent(e.payload):this.gatewayEvents.handleGatewayAgentEvent(e.payload):this.handleGatewayResponse(e)}handleGatewayDisconnected(){this.core.handleGatewayDisconnected()}handleGatewayResponse(e){this.historyReplay.handleHistoryResponse(e)||this.gatewayEvents.handleGatewayResponse(e)}}