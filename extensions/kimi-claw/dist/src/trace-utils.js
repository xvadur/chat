import{createHash}from"node:crypto";import{mkdirSync,writeFileSync}from"node:fs";import path from"node:path";import{asRpcId,isRecord}from"./utils/json.js";import{asTrimmedNonEmptyString as asString}from"./utils/text.js";const BASE64_PAYLOAD_REGEX=/^[A-Za-z0-9+/]*={0,2}$/,readSessionIdentifiersFromRecord=e=>{const r=asString(e.sessionId),t=asString(e.sessionKey),s=isRecord(e._meta)?e._meta:void 0,i=s?asString(s.sessionId):void 0,o=s?asString(s.sessionKey):void 0,a=s&&isRecord(s.openclaw)?s.openclaw:void 0,n=a?asString(a.sessionId):void 0,d=a?asString(a.sessionKey):void 0;return{sessionId:r??i??n,sessionKey:t??o??d}},mergeSessionIdentifiers=(...e)=>{let r,t;for(const s of e){if(!isRecord(s))continue;const e=readSessionIdentifiersFromRecord(s);if(!r&&e.sessionId&&(r=e.sessionId),!t&&e.sessionKey&&(t=e.sessionKey),r&&t)break}return{sessionId:r,sessionKey:t}},extractRequestId=e=>{const r=isRecord(e.params)?e.params:void 0,t=isRecord(e.payload)?e.payload:void 0,s=isRecord(e.result)?e.result:void 0,i=isRecord(e.error)?e.error:void 0,o=i&&isRecord(i.data)?i.data:void 0,a=r&&isRecord(r._meta)?r._meta:void 0,n=s&&isRecord(s._meta)?s._meta:void 0,d=o&&isRecord(o._meta)?o._meta:void 0,c=t&&isRecord(t.data)?t.data:void 0,u=[e.id,e.requestId,e.request_id,r?.requestId,r?.request_id,a?.requestId,t?.requestId,t?.request_id,c?.requestId,c?.request_id,s?.requestId,n?.requestId,o?.requestId,o?.request_id,d?.requestId,d?.request_id];for(const e of u){const r=asRpcId(e);if(r)return r}},extractMethod=e=>asString(e.method),extractEvent=e=>{const r=asString(e.event);if(r)return r;if("terminal/update"===asString(e.method)){const r=isRecord(e.params)?e.params:void 0;return r?asString(r.event):void 0}},extractTerminalId=e=>{const r=isRecord(e.params)?e.params:void 0,t=isRecord(e.payload)?e.payload:void 0,s=t&&isRecord(t.data)?t.data:void 0,i=isRecord(e.result)?e.result:void 0,o=isRecord(e.error)?e.error:void 0,a=o&&isRecord(o.data)?o.data:void 0,n=[e.terminalId,r?.terminalId,t?.terminalId,s?.terminalId,i?.terminalId,a?.terminalId];for(const e of n){const r=asString(e);if(r)return r}},extractTerminalEvent=e=>{if("terminal/update"===asString(e.method)){const r=isRecord(e.params)?e.params:void 0,t=r?asString(r.event):void 0;if(t)return t}if("event"===asString(e.type)&&"agent"===asString(e.event)){const r=isRecord(e.payload)?e.payload:void 0;if("lifecycle"===asString(r?.stream)){const e=r&&isRecord(r.data)?r.data:void 0,t=asString(e?.phase);if("end"===t)return"end_turn";if("cancel"===t||"cancelled"===t)return"cancelled";if("error"===t)return"error"}}if(Object.prototype.hasOwnProperty.call(e,"error")&&void 0!==e.error)return"error";const r=isRecord(e.result)?e.result:void 0,t=r?asString(r.stopReason):void 0;if(t)return t;if("session/update"===asString(e.method)){const r=isRecord(e.params)?e.params:void 0,t=r&&isRecord(r.update)?r.update:void 0,s=t?asString(t.sessionUpdate):void 0;if("agent_run_end"===s)return"end_turn";if("agent_run_cancelled"===s)return"cancelled";const i=t?asString(t.stopReason):void 0;if(i)return i}},extractProtocolError=e=>"res"===asString(e.type)&&!1===e.ok||Object.prototype.hasOwnProperty.call(e,"error")&&void 0!==e.error,summarizeError=e=>{if(!isRecord(e))return"error";const r=asString(e.message),t=asString(e.code);return r||t||"error"},summarizePayload=e=>{const r=asString(e.type);if("req"===r)return`gateway.req:${asString(e.method)??"unknown"}`;if("res"===r){if(!1===e.ok)return`gateway.res:error:${summarizeError(e.error)}`;const r=isRecord(e.payload)?e.payload:void 0,t=r?asString(r.stopReason):void 0;return t?`gateway.res:stop:${t}`:"gateway.res:ok"}if("event"===r){const r=asString(e.event)??"unknown",t=isRecord(e.payload)?e.payload:void 0,s=t?asString(t.stream):void 0,i=t&&isRecord(t.data)?t.data:void 0,o=i?asString(i.phase):void 0;return s&&o?`gateway.event:${r}:${s}:${o}`:s?`gateway.event:${r}:${s}`:`gateway.event:${r}`}const t=asString(e.method);if(t){if("terminal/update"===t){const r=isRecord(e.params)?e.params:void 0;return`acp.notify:terminal/update:${(r?asString(r.event):void 0)??"unknown"}`}if("session/update"===t){const r=isRecord(e.params)?e.params:void 0,t=r&&isRecord(r.update)?r.update:void 0;return`acp.notify:session/update:${(t?asString(t.sessionUpdate):void 0)??"unknown"}`}return void 0===e.id?`acp.notify:${t}`:`acp.req:${t}`}if(Object.prototype.hasOwnProperty.call(e,"error")&&void 0!==e.error)return`acp.res:error:${summarizeError(e.error)}`;const s=isRecord(e.result)?e.result:void 0,i=s?asString(s.stopReason):void 0;if(i)return`acp.res:stop:${i}`;if(s)return"acp.res:ok";const o=Object.keys(e);return 0===o.length?"json:empty":`json:${o.slice(0,4).join(",")}`},asBase64SizeBytes=e=>{if("string"==typeof e&&e&&e.length%4==0&&BASE64_PAYLOAD_REGEX.test(e))return Buffer.from(e,"base64").byteLength},DEFAULT_TERMINAL_ARTIFACT_DIR="/tmp/openclaw_obs_artifacts",normalizeTerminalPayloadMode=e=>"artifact"===e||"inline"===e||"size_only"===e?e:"size_only",persistTerminalBase64Artifact=(e,r)=>{const t=path.resolve(asString(r)??"/tmp/openclaw_obs_artifacts"),s=createHash("sha256").update(e,"utf8").digest("hex"),i=asBase64SizeBytes(e)??e.length,o=path.posix.join("terminal",`${s}.b64`),a=path.join(t,...o.split("/"));try{mkdirSync(path.dirname(a),{recursive:!0});try{writeFileSync(a,e,{encoding:"utf8",flag:"wx"})}catch(e){if("EEXIST"!==(e&&"object"==typeof e&&"code"in e?e.code:void 0))throw e}return{artifactRef:o,sha256:s,sizeBytes:i}}catch{return}},sanitizeTerminalParamsForTrace=(e,r,t)=>{const s=r.dataBase64;if("string"!=typeof s)return;const i=normalizeTerminalPayloadMode(t?.terminalPayloadMode);if("inline"===i)return;const o="terminal/input"===e,a="terminal/update"===e&&"stdout"===asString(r.event);if(!o&&!a)return;const n=asBase64SizeBytes(s)??s.length;if("artifact"===i){const e=asString(t?.terminalArtifactDir)??"/tmp/openclaw_obs_artifacts",i=persistTerminalBase64Artifact(s,e);if(i){const e={...r};return o?(e.inputSizeBytes=i.sizeBytes,e.inputArtifact=i):(e.outputSizeBytes=i.sizeBytes,e.outputArtifact=i),delete e.dataBase64,e}}const d={...r};return o?d.inputSizeBytes=n:d.outputSizeBytes=n,delete d.dataBase64,d};export const classifyTraceDirection=e=>e.endsWith("->plugin")?"inbound":e.startsWith("plugin->")?"outbound":"internal";export const buildStructuredTraceFields=(e,r,t)=>{if(!isRecord(r))return{timestamp:t,direction:classifyTraceDirection(e),payloadSummary:"non_object:"+typeof r,protocolError:!1};const s=isRecord(r.params)?r.params:void 0,i=isRecord(r.payload)?r.payload:void 0,o=isRecord(r.result)?r.result:void 0,a=isRecord(r.error)?r.error:void 0,n=a&&isRecord(a.data)?a.data:void 0,{sessionId:d,sessionKey:c}=mergeSessionIdentifiers(r,s,i,o,n),u=extractRequestId(r),l=extractMethod(r),p=extractEvent(r),m=extractTerminalId(r),f=extractTerminalEvent(r);return{timestamp:t,direction:classifyTraceDirection(e),requestId:u,sessionId:d,sessionKey:c,terminalId:m,method:l,event:p,payloadSummary:summarizePayload(r),protocolError:extractProtocolError(r),...f?{terminalEvent:f}:{}}};export const sanitizeTracePayloadForLogging=(e,r)=>{if(!isRecord(e))return e;const t=asString(e.method);if(!t||!t.startsWith("terminal/"))return e;const s=isRecord(e.params)?e.params:void 0;if(!s)return e;const i=sanitizeTerminalParamsForTrace(t,s,r);return i?{...e,params:i}:e};const normalizeFilterValue=e=>{if("string"!=typeof e)return;return e.trim()||void 0};export const normalizeTraceFilter=e=>({requestId:normalizeFilterValue(e.requestId),sessionId:normalizeFilterValue(e.sessionId)});export const rowMatchesTraceFilter=(e,r)=>{const t=normalizeTraceFilter(r);if(t.requestId&&asRpcId(e.requestId)!==t.requestId)return!1;if(t.sessionId){const r=asString(e.sessionId),s=asString(e.sessionKey);if(r!==t.sessionId&&s!==t.sessionId)return!1}return!0};