import{buildStructuredTraceFields,rowMatchesTraceFilter,sanitizeTracePayloadForLogging}from"../trace-utils.js";import{isRecord}from"../utils/json.js";import{createRollingJsonlWriter,DEFAULT_LOG_ROLLING_MAX_BYTES}from"../utils/rolling-jsonl.js";export const buildAllTrace=(r,t,e)=>{const o=r.trim();if(!o)return r=>{};const a=createRollingJsonlWriter({filePath:o,logger:t,contextLabel:"trace",maxBytes:DEFAULT_LOG_ROLLING_MAX_BYTES});return r=>{rowMatchesTraceFilter(r,e)&&a(r)}};export const buildForwardTrace=(r,t,e,o,a)=>{const i=r.trim();if(!i)return(r,t)=>{};const l=createRollingJsonlWriter({filePath:i,logger:t,contextLabel:"trace",maxBytes:DEFAULT_LOG_ROLLING_MAX_BYTES});return(r,t)=>{const i=(new Date).toISOString(),c={ts:i,trace:"forward",link:r,...buildStructuredTraceFields(r,t,i)};if(!rowMatchesTraceFilter(c,e))return;const n=sanitizeTracePayloadForLogging(t,a),s={...c,payload:n};l(s),o?.(s)}};export const buildReplyTrace=(r,t,e,o,a)=>{const i=r.trim();if(!i)return(r,t)=>{};const l=createRollingJsonlWriter({filePath:i,logger:t,contextLabel:"trace",maxBytes:DEFAULT_LOG_ROLLING_MAX_BYTES});let c=0;return(r,t)=>{c+=1;const i=(new Date).toISOString(),n=buildStructuredTraceFields(r,t,i),s={ts:i,trace:"reply",seq:c,stage:r,...n};if(!rowMatchesTraceFilter(s,e))return;const g=sanitizeTracePayloadForLogging(t,a),u={...s,...isRecord(g)?g:{payload:g}};l(u),o?.(u)}};