import{AcpGatewayBridge}from"../acp-gateway-bridge.js";import{JsonRpcWsClient}from"../jsonrpc-ws-client.js";import{TerminalBridgeHandler}from"../terminal-bridge-handler.js";import{TerminalSessionManager}from"../terminal-session-manager.js";import{buildDeviceAuthField,loadOrCreateDeviceIdentity}from"../utils/device-identity.js";import{isRecord}from"../utils/json.js";import{asTrimmedNonEmptyString as asString}from"../utils/text.js";import{HandshakeWsClient}from"../ws-client.js";const defaultJsonRpcClientFactory=e=>new JsonRpcWsClient(e),defaultHandshakeClientFactory=e=>new HandshakeWsClient(e),defaultAcpGatewayBridgeFactory=e=>new AcpGatewayBridge(e),KIMI_CLAW_VERSION_HEADER="X-Kimi-Claw-Version",ACP_TERMINAL_MAX_CONCURRENT_SESSIONS=10,buildGatewayConnectFrame=(e,r,s)=>{const a="operator",t=["operator.admin"],i={minProtocol:e.gateway.protocol,maxProtocol:e.gateway.protocol,client:{id:e.gateway.clientId,version:r,platform:process.platform,mode:e.gateway.clientMode,displayName:"kimi-bridge-connector"},role:a,scopes:t,caps:["tool-events"]};e.gateway.token&&(i.auth={token:e.gateway.token});const o=loadOrCreateDeviceIdentity();return i.device=buildDeviceAuthField({identity:o,clientId:e.gateway.clientId,clientMode:e.gateway.clientMode,role:a,scopes:t,token:e.gateway.token,nonce:s}),{type:"req",id:"connect",method:"connect",params:i}},toObsRequestId=e=>"string"==typeof e||"number"==typeof e?String(e):void 0,resolveObsSessionId=e=>{if(isRecord(e))return asString(e.sessionId)??asString(e.sessionKey)??(isRecord(e._meta)?asString(e._meta.sessionId)??asString(e._meta.sessionKey):void 0)},resolveBridgeMessageObsContext=e=>{if(!isRecord(e))return{};const r=toObsRequestId(e.id),s=isRecord(e.params)?e.params:void 0,a=isRecord(e.result)?e.result:void 0,t=isRecord(e.error)?e.error:void 0,i=isRecord(t?.data)?t.data:void 0,o=resolveObsSessionId(s)??resolveObsSessionId(a)??resolveObsSessionId(i);return o?{requestId:r,sessionId:o,sessionKey:o}:{requestId:r}},resolveGatewayFrameObsContext=e=>{if(!isRecord(e))return{};const r=toObsRequestId(e.id),s=asString(e.method),a=asString(e.type),t=isRecord(e.params)?e.params:void 0,i=isRecord(e.payload)?e.payload:void 0,o=resolveObsSessionId(t)??resolveObsSessionId(i);return{requestId:r,...o?{sessionId:o,sessionKey:o}:{},...s?{method:s}:{},...a?{frameType:a}:{}}};export const createAcpModeClients=e=>{const r=e.createJsonRpcClient??defaultJsonRpcClientFactory,s=e.createHandshakeClient??defaultHandshakeClientFactory,a=e.createAcpGatewayBridge??defaultAcpGatewayBridgeFactory,{cfg:t,logger:i}=e,o={[KIMI_CLAW_VERSION_HEADER]:e.connectVersion};i.info("[acp] mode=acp using direct gateway adapter path (no subprocess)"),i.info(`[acp] prompt timeout fallback=${t.bridge.promptTimeoutMs}ms`);let n=null,d=null;const l=r=>{e.writeObsEvent({component:"connector",domain:"transport",name:r.name,severity:"warn",...r.requestId?{requestId:r.requestId}:{},...r.sessionId?{sessionId:r.sessionId,sessionKey:r.sessionKey??r.sessionId}:{},hop:r.hop,where:r.where,summary:r.summary,payload:{reason:r.reason,direction:r.hop,...r.payload??{}}})},c=r=>!(!n||!n.isReady())&&(e.traceForward("plugin->bridge_ws",r),isRecord(r)&&e.traceReply("plugin->bridge_ws",r),n.send(r));let g;if(t.bridge.shell.enabled){const e=new TerminalSessionManager({defaultShell:t.bridge.shell.defaultShell,defaultCwd:process.cwd(),idleTimeoutMs:t.bridge.shell.idleTimeoutMs||void 0,maxDurationMs:t.bridge.shell.maxDurationMs||void 0});g=new TerminalBridgeHandler({manager:e,sendBridgeMessage:c,logger:i,shell:{enabled:t.bridge.shell.enabled,defaultShell:t.bridge.shell.defaultShell,maxConcurrentSessions:10,idleTimeoutMs:t.bridge.shell.idleTimeoutMs,maxDurationMs:t.bridge.shell.maxDurationMs,defaultCwd:process.cwd()}})}const m=a({logger:i,instanceMeta:{instanceId:t.bridge.instanceId,deviceId:t.bridge.deviceId,pluginVersion:e.connectVersion},agentId:t.gateway.agentId,isGatewayReady:()=>!!d?.isReady(),sendBridgeMessage:e=>{if(!c(e)){i.warn("bridge ACP disconnected; dropping adapter message");const r=!!n?.isReady(),s=r?"bridge_send_failed":"bridge_not_ready",a=resolveBridgeMessageObsContext(e);l({name:"transport.drop",hop:"plugin->bridge_ws",where:"createAcpModeClients.sendBridgeMessage",summary:`bridge ACP ${r?"send failed":"not ready"}; dropped adapter message`,reason:s,requestId:a.requestId,sessionId:a.sessionId,sessionKey:a.sessionKey,payload:{target:"bridge-acp"}})}},sendGatewayFrame:r=>{e.traceForward("plugin->openclaw_gateway",r);const s=d?.send(r)??!1;if(!s){const e=!!d?.isReady(),s=e?"gateway_send_failed":"gateway_not_ready",a=resolveGatewayFrameObsContext(r);l({name:"transport.degrade",hop:"plugin->openclaw_gateway",where:"createAcpModeClients.sendGatewayFrame",summary:`gateway ${e?"send failed":"not ready"}; degraded ACP forward`,reason:s,requestId:a.requestId,sessionId:a.sessionId,sessionKey:a.sessionKey,payload:{target:"openclaw_gateway",...a.method?{method:a.method}:{},...a.frameType?{frameType:a.frameType}:{}}})}return s},webSshEnabled:t.bridge.shell.enabled,writeObsEvent:e.writeObsEvent,forceRealtimeVerbose:!0,forceReasoningStream:!0,forwardThinkingToBridge:t.bridge.forwardThinking,forwardToolCallsToBridge:t.bridge.forwardToolCalls,promptTimeoutMs:t.bridge.promptTimeoutMs,historyPendingTimeoutMs:t.bridge.historyPendingTimeoutMs,kimiapiHost:t.bridge.kimiapiHost,kimiBotToken:t.bridge.token,kimiFileDownloadDir:t.bridge.kimiFileDownloadDir,traceAll:e.traceAll,terminalHandler:g});return n=r({name:"bridge-acp",url:t.bridge.url,headers:o,token:t.bridge.token,logger:i,writeObsEvent:e.writeObsEvent,retry:t.retry,onMessage:r=>{e.traceForward("bridge_ws->plugin",r),isRecord(r)&&e.traceReply("bridge_ws->plugin",r),m.handleBridgeMessage(r)},onReady:()=>{i.info(`bridge ACP connected url=${t.bridge.url} instance_id=${t.bridge.instanceId} device_id=${t.bridge.deviceId}`)},onClose:()=>{i.warn("bridge ACP disconnected")}}),d=s({name:"gateway",url:t.gateway.url,headers:o,logger:i,writeObsEvent:e.writeObsEvent,obsHop:"gateway_ws",retry:t.retry,buildConnect:r=>buildGatewayConnectFrame(t,e.connectVersion,r),onFrame:r=>{e.traceForward("openclaw_gateway->plugin",r),m.handleGatewayFrame(r)},onReady:()=>{i.info(`local gateway connected url=${t.gateway.url} (acp adapter mode)`)},onClose:()=>{i.warn("local gateway disconnected"),e.isStopped()||m.handleGatewayDisconnected()}}),{bridgeClient:n,gatewayClient:d,terminalHandler:g}};