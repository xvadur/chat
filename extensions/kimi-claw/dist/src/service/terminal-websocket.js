import{randomUUID}from"node:crypto";import{TerminalSessionManager}from"../terminal-session-manager.js";import{WebSocket,WebSocketServer}from"ws";const toBuffer=e=>"string"==typeof e?Buffer.from(e,"utf8"):Buffer.from(e),readPositiveInteger=e=>{if("number"==typeof e&&Number.isInteger(e)&&!(e<=0))return e},parseControlMessage=e=>{const t=toBuffer(e).toString("utf8").trim();if(!t||"{"!==t[0])return null;let r;try{r=JSON.parse(t)}catch{return null}if(!r||"object"!=typeof r||Array.isArray(r))return null;const o=r,n="string"==typeof o.type?o.type.trim().toLowerCase():"";if("heartbeat"===n||"ping"===n||"keepalive"===n||!0===o.heartbeat)return{type:"heartbeat"};if(!0!==o.resize&&"resize"!==n)return null;const s=readPositiveInteger(o.cols),i=readPositiveInteger(o.rows);if(!s)throw new Error("invalid resize payload: cols must be a positive integer");if(!i)throw new Error("invalid resize payload: rows must be a positive integer");return{type:"resize",cols:s,rows:i}},normalizeClientIdentity=e=>{const t=e.trim().toLowerCase();if(!t)return"";try{return t.includes("://")?new URL(t).hostname:t}catch{const e=t.split("/")[0];if(!e)return"";if("localhost"===e)return e;const r=e.startsWith("[")&&e.endsWith("]")?e.slice(1,-1):e,o=r.includes("::ffff:")?r.slice(7):r;return o.includes(":")&&!o.includes("::")?o.split(":")[0]:o}},readHeaderValues=e=>e?(Array.isArray(e)?e:[e]).flatMap(e=>e.split(",").map(e=>e.trim()).filter(e=>e.length>0)):[],collectClientIdentities=e=>{const t=new Set;for(const r of readHeaderValues(e.headers.origin)){const e=normalizeClientIdentity(r);e&&t.add(e)}for(const r of readHeaderValues(e.headers.host)){const e=normalizeClientIdentity(r);e&&t.add(e)}for(const r of readHeaderValues(e.headers["x-forwarded-for"])){const e=normalizeClientIdentity(r);e&&t.add(e)}if(e.socket.remoteAddress){const r=normalizeClientIdentity(e.socket.remoteAddress);r&&t.add(r)}return[...t]},isAuthorizedConnection=e=>{const t=e.expectedToken,r=readToken(e.requestUrl,e.requestHost,t);if(t&&r===t)return{isAuthorized:!0,reason:"token"};if(e.allowedOrigins&&e.allowedOrigins.length>0){const r=collectClientIdentities(e.request),o=new Set(e.allowedOrigins.map(e=>e.toLowerCase()));for(const e of r)if(o.has(e))return{isAuthorized:!0,reason:"allowlist"};const n=r.join(",");return t?{isAuthorized:!1,reason:`token mismatch and not allowlisted host=${n||"unknown"}`}:{isAuthorized:!1,reason:`not allowlisted host=${n||"unknown"}`}}return t?{isAuthorized:!1,reason:`invalid token=${r??"missing"}`}:{isAuthorized:!0,reason:"allow-all"}},readToken=(e,t,r)=>{if(!r)return r;try{return new URL(e??"/",t?`http://${t}`:"http://127.0.0.1").searchParams.get("token")??void 0}catch(e){return}};export const createTerminalWebSocketService=e=>{const t=e.config;if(!t||!t.enabled||t.port<=0)return{start:()=>{},stop:()=>{}};const r=readPositiveInteger(t.idleTimeoutMs),o=readPositiveInteger(t.maxDurationMs),n={port:t.port,host:t.host??"127.0.0.1",path:t.path??"/terminal",...r?{idleTimeoutMs:r}:{},...o?{maxDurationMs:o}:{},enabled:!0,...t.token?{token:t.token}:{},...t.allowedOrigins?{allowedOrigins:t.allowedOrigins}:{}},s=e.logger,i=new TerminalSessionManager({defaultShell:e.defaultShell,idleTimeoutMs:n.idleTimeoutMs,maxDurationMs:n.maxDurationMs,createProcess:e.createProcess,onOutput:()=>{},onExit:()=>{}}),a=new Map,l=new Map;let d=null,c=null;const u=e=>{if(!e)return;const t=a.get(e);if(t){a.delete(e),l.delete(t);try{i.closeSession(t)}catch(e){s.warn(`[terminal ws] failed to close terminal session on socket close terminalId=${t}: ${e instanceof Error?e.message:String(e)}`)}}e.readyState!==WebSocket.OPEN&&e.readyState!==WebSocket.CONNECTING||e.close(1001,"terminal ws closed"),t&&s.debug(`[terminal ws] socket cleanup terminalId=${t}`)};return i.addListeners({onOutput:e=>{const t=l.get(e.terminalId);t&&t.readyState===WebSocket.OPEN&&t.send(e.data,e=>{e&&s.warn(`[terminal ws] failed to send output to client: ${e instanceof Error?e.message:String(e)}`)})},onExit:e=>{const t=l.get(e.terminalId),r=`[terminal ws] terminal exited terminalId=${e.terminalId} sessionId=${e.sessionId} code=${e.code??-1} signal=${e.signal??"none"} reason=${e.reason??"unknown"}${e.error?` error=${e.error.message}`:""}`;e.error?s.error(r):s.info(r),t&&t.readyState===WebSocket.OPEN&&t.close(1e3,`terminal exited code=${e.code??-1}`),t&&u(t)},onStateChange:e=>{s.debug(`[terminal ws] state ${e.from}->${e.to} terminalId=${e.terminalId}`)}}),{start:()=>{if(d)return;if(c)return void s.error(`[terminal ws] skipping start due previous server error: ${c instanceof Error?c.message:String(c)}`);let e;try{e={host:n.host,port:n.port,path:n.path},d=new WebSocketServer(e)}catch(e){const t=e instanceof Error?e:new Error(String(e));return c=t,void s.error(`[terminal ws] failed to bind websocket server: ${t.message}`)}d.on("connection",(e,t)=>{const r=n.token,o=isAuthorizedConnection({request:t,expectedToken:r,allowedOrigins:n.allowedOrigins,requestUrl:t.url,requestHost:t.headers.host});if(!o.isAuthorized){const n=o.reason,i=n.includes("token")?"invalid token":"access denied";return s.warn(`[terminal ws] rejected connection reason=${n} ip=${t.socket.remoteAddress??"unknown"} token=${r?"configured":"missing"}`),void e.close(1008,i)}s.info(`[terminal ws] connection authorized via ${o.reason} ip=${t.socket.remoteAddress??"unknown"}`);const d=randomUUID();let c;try{const e=i.openSession({sessionId:d,cols:120,rows:40});c=e.terminalId}catch(t){return s.error(`[terminal ws] failed to open terminal session sessionId=${d}: ${t instanceof Error?t.message:String(t)}`),void e.close(1011,"terminal bootstrap failure")}a.set(e,c),l.set(c,e),s.info(`[terminal ws] client connected terminalId=${c}`),e.on("message",t=>{const r=a.get(e);if(r){try{const e=parseControlMessage(t);if("resize"===e?.type)return void i.resizeSession(r,e.cols,e.rows);if("heartbeat"===e?.type)return void i.touchSession(r)}catch(e){return void s.warn(`[terminal ws] failed to process control payload terminalId=${r}: ${e instanceof Error?e.message:String(e)}`)}try{i.writeToSession(r,toBuffer(t))}catch(t){const o=t instanceof Error?t.message:String(t);s.warn(`[terminal ws] failed to write input terminalId=${r}: ${o}`),e.close(1011,o)}}else e.close(1008,"terminal session missing")}),e.on("close",()=>{u(e)}),e.on("error",t=>{s.warn(`[terminal ws] socket error terminalId=${c}: ${t.message}`),u(e)})}),d.on("error",e=>{s.error(`[terminal ws] websocket server error: ${e.message}`)}),s.info(`[terminal ws] listening ws://${n.host}:${n.port}${n.path}`)},stop:()=>{if(d){try{for(const e of i.listSessions())i.closeSession(e.terminalId)}catch(e){s.warn(`[terminal ws] failed to close terminal sessions: ${e instanceof Error?e.message:String(e)}`)}for(const e of[...a.keys()])u(e);d.close(),d=null,s.info("[terminal ws] stopped")}}}};