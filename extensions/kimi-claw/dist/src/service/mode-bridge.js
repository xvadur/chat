import{buildDeviceAuthField,loadOrCreateDeviceIdentity}from"../utils/device-identity.js";import{HandshakeWsClient}from"../ws-client.js";const defaultHandshakeClientFactory=e=>new HandshakeWsClient(e),KIMI_CLAW_VERSION_HEADER="X-Kimi-Claw-Version",buildBridgeConnectFrame=(e,r)=>{const t={minProtocol:e.bridge.protocol,maxProtocol:e.bridge.protocol,client:{id:`im:${e.bridge.userId}`,version:r,platform:process.platform,mode:"backend"},role:"operator",scopes:["operator.read","operator.write"],locale:"zh-CN",userAgent:"kimi-claw"};return e.bridge.token&&(t.auth={token:e.bridge.token}),{type:"req",id:"connect",method:"connect",params:t}},buildGatewayConnectFrame=(e,r,t)=>{const o="operator",n=["operator.admin"],a={minProtocol:e.gateway.protocol,maxProtocol:e.gateway.protocol,client:{id:e.gateway.clientId,version:r,platform:process.platform,mode:e.gateway.clientMode,displayName:"kimi-bridge-connector"},role:o,scopes:n,caps:["tool-events"]};e.gateway.token&&(a.auth={token:e.gateway.token});const i=loadOrCreateDeviceIdentity();return a.device=buildDeviceAuthField({identity:i,clientId:e.gateway.clientId,clientMode:e.gateway.clientMode,role:o,scopes:n,token:e.gateway.token,nonce:t}),{type:"req",id:"connect",method:"connect",params:a}},formatContext=e=>{const r=[];return e.userId&&r.push(`user_id=${e.userId}`),e.requestId&&r.push(`request_id=${e.requestId}`),e.runId&&r.push(`run_id=${e.runId}`),r.length?r.join(" "):"context=none"};export const createBridgeModeClients=e=>{const r=e.createHandshakeClient??defaultHandshakeClientFactory,{cfg:t,logger:o}=e,n={[KIMI_CLAW_VERSION_HEADER]:e.connectVersion};let a=null,i=null;return a=r({name:"bridge",url:t.bridge.url,headers:n,logger:o,retry:t.retry,buildConnect:()=>buildBridgeConnectFrame(t,e.connectVersion),onFrame:r=>{if(e.traceForward("bridge_ws->plugin",r),"req"!==r.type)return void o.debug?.("ignoring non-req frame from bridge");const n=r.id,d=formatContext({requestId:n,userId:t.bridge.userId});if(!i||!i.isReady()){o.warn(`gateway offline for ${d}`);const r={type:"res",id:n,ok:!1,error:{code:"GATEWAY_OFFLINE",message:"gateway offline"}};return e.traceForward("plugin->bridge_ws",r),void a?.send(r)}e.traceForward("plugin->openclaw_gateway",r),i.send(r),o.debug?.(`bridge req forwarded ${d}`)},onReady:()=>{o.info(`bridge connected url=${t.bridge.url} user_id=${t.bridge.userId}`)},onClose:()=>{o.warn(`bridge disconnected user_id=${t.bridge.userId}`)}}),i=r({name:"gateway",url:t.gateway.url,headers:n,logger:o,writeObsEvent:e.writeObsEvent,obsHop:"gateway_ws",retry:t.retry,buildConnect:r=>buildGatewayConnectFrame(t,e.connectVersion,r),onFrame:r=>{a&&a.isReady()?"event"===r.type&&"agent"!==r.event||(e.traceForward("openclaw_gateway->plugin",r),e.traceForward("plugin->bridge_ws",r),a.send(r)):o.debug?.("bridge not ready; dropping gateway frame")},onReady:()=>{o.info(`local gateway connected url=${t.gateway.url}`)},onClose:()=>{o.warn("local gateway disconnected")}}),{bridgeClient:a,gatewayClient:i}};