import{mkdirSync,writeFileSync}from"node:fs";import{homedir}from"node:os";import{dirname,join}from"node:path";import{asTrimmedNonEmptyString}from"./utils/text.js";const DEFAULT_OPENCLAW_CONFIG_PATH=join(homedir(),".openclaw","openclaw.json"),DEFAULT_OPENCLAW_MIRROR_PATH=join(homedir(),".kimi","kimi-claw","openclaw.json");export function mirrorOpenClawConfigToLocalDir(e){const i=e?.mirrorPath??DEFAULT_OPENCLAW_MIRROR_PATH,r=e?.openclawConfig;if(!r||"object"!=typeof r||Array.isArray(r))return{destinationPath:i,copied:!1,reason:"config_invalid"};try{return mkdirSync(dirname(i),{recursive:!0}),writeFileSync(i,`${JSON.stringify(r,null,2)}\n`,{encoding:"utf8",mode:384}),{destinationPath:i,copied:!0}}catch(e){const r=e;return{destinationPath:i,copied:!1,reason:"write_failed",error:r?.message}}}const DEFAULT_BRIDGE_URL="wss://www.kimi.com/api-claw/bots/agent-ws",DEFAULT_GATEWAY_URL="ws://127.0.0.1:18789",DEFAULT_PROTOCOL=3,DEFAULT_CLIENT_ID="gateway-client",DEFAULT_CLIENT_MODE="backend",DEFAULT_AGENT_ID="main",DEFAULT_BRIDGE_MODE="acp",DEFAULT_INSTANCE_ID_PREFIX="connector",DEFAULT_DEVICE_ID="unknown-device",DEFAULT_KIMIAPI_HOST="https://www.kimi.com/api-claw",DEFAULT_KIMI_FILE_DOWNLOAD_DIR="./openclaw/kimi/downloads",DEFAULT_FORWARD_THINKING=!1,DEFAULT_FORWARD_TOOL_CALLS=!1,DEFAULT_PROMPT_TIMEOUT_MS=18e5,DEFAULT_HISTORY_PENDING_TIMEOUT_MS=15e3,DEFAULT_RETRY_BASE_MS=1e3,DEFAULT_RETRY_MAX_MS=6e5,DEFAULT_RETRY_MAX_ATTEMPTS=0,DEFAULT_LOG_DIR=join(homedir(),".kimi","kimi-claw","log"),DEFAULT_LOG_ENABLED=!1,DEFAULT_VERBOSE_LOG=!1,DEFAULT_FORWARD_LOG_FILE=join(DEFAULT_LOG_DIR,"openclaw_forward_chain.log"),DEFAULT_REPLY_LOG_FILE=join(DEFAULT_LOG_DIR,"openclaw_reply_stream.log"),DEFAULT_ALL_LOG_FILE=join(DEFAULT_LOG_DIR,"openclaw_all_trace.log"),DEFAULT_WS_OBS_LOG_FILE=join(DEFAULT_LOG_DIR,"openclaw_ws_observability.log"),DEFAULT_TERMINAL_PAYLOAD_MODE="artifact",DEFAULT_TERMINAL_ARTIFACT_DIR="/tmp/openclaw_obs_artifacts",DEFAULT_MODEL_ENABLED=!1,DEFAULT_MODEL_PROVIDER="kimi-coding",DEFAULT_MODEL_ID="k2p5",DEFAULT_MODEL_BASE_URL="https://api.kimi.com/coding",DEFAULT_SHELL_ENABLED=!1,DEFAULT_SHELL_MAX_CONCURRENT_SESSIONS=10,DEFAULT_SHELL_IDLE_TIMEOUT_MS=432e5,DEFAULT_SHELL_MAX_DURATION_MS=432e5,DEFAULT_SHELL_DEFAULT_SHELL="/bin/bash",DEFAULT_TERMINAL_WS_ENABLED=!1,DEFAULT_TERMINAL_WS_HOST="127.0.0.1",DEFAULT_TERMINAL_WS_PATH="/terminal",readString=e=>asTrimmedNonEmptyString(e),readNumber=e=>"number"==typeof e&&Number.isFinite(e)?e:void 0,readInteger=e=>"number"==typeof e&&Number.isFinite(e)?Math.trunc(e):void 0,readBoolean=e=>"boolean"==typeof e?e:void 0,normalizeTerminalWsAllowedOrigin=e=>{const i=readString(e);if(!i)return;const r=i.includes("://")?i:`http://${i}`;try{return new URL(r).hostname.toLowerCase()}catch{const e=i.trim().split("/")[0];if(!e)return;const r=e.toLowerCase();return"localhost"===r?r:r.startsWith("[")&&r.endsWith("]")?r.slice(1,-1):r.includes("::ffff:")?r.slice(7):r.includes(":")&&!r.includes("::")?r.split(":")[0]:r}},normalizeTerminalWsAllowedOrigins=e=>{const i=Array.isArray(e)?e:[];if(!i.length)return;const r=i.map(e=>normalizeTerminalWsAllowedOrigin(e)).filter(e=>"string"==typeof e&&e.length>0);return r.length?[...new Set(r)]:void 0},pickRequired=(e,i)=>{for(const i of e)if(void 0!==i.value)return{value:i.value,source:i.source};return i},pickOptional=e=>{for(const i of e)if(void 0!==i.value)return{value:i.value,source:i.source};return{value:void 0,source:"default"}},pickTruthyNumber=(e,i)=>{for(const i of e)if(i.value)return{value:i.value,source:i.source};return i},normalizeBridgeMode=e=>{const i=readString(e);if("gateway"===i||"acp"===i)return i},normalizeTerminalPayloadMode=e=>{const i=readString(e);if("artifact"===i||"inline"===i||"size_only"===i)return i},validateResolvedConfig=e=>{const i=[];return e.config.bridge.token||i.push({code:"CONFIG_BRIDGE_TOKEN_MISSING",severity:"error",message:"bridge.token missing; remote ACP WebSocket auth may fail",nextSteps:[`Set plugins.entries.kimi-claw.config.bridge.token in ${e.openclawConfigPath}`,"Or run ./scripts/sync_local_config_to_openclaw.sh to import ~/.kimi/kimi-claw/kimi-claw-config.json"]}),e.config.bridge.terminalWs?.enabled&&e.config.bridge.terminalWs.port<=0&&i.push({code:"CONFIG_TERMINAL_WS_PORT_MISSING",severity:"warn",message:"bridge.terminalWs enabled but terminal port is missing or invalid",nextSteps:[`Set plugins.entries.kimi-claw.config.bridge.terminalWs.port in ${e.openclawConfigPath}`,"Or set bridge.terminalWs.enabled to false"]}),!e.config.bridge.terminalWs?.enabled||e.config.bridge.terminalWs.token||e.config.bridge.terminalWs.allowedOrigins&&e.config.bridge.terminalWs.allowedOrigins.length>0||i.push({code:"CONFIG_TERMINAL_WS_ACCESS_CONTROL_MISSING",severity:"warn",message:"bridge.terminalWs is enabled without token or whitelist-based access control",nextSteps:[`Set plugins.entries.kimi-claw.config.bridge.terminalWs.token in ${e.openclawConfigPath}`,`Or set plugins.entries.kimi-claw.config.bridge.terminalWs.allowedOrigins in ${e.openclawConfigPath}`]}),"gateway"!==e.config.bridge.mode||e.config.bridge.userId||i.push({code:"CONFIG_BRIDGE_USER_ID_MISSING",severity:"error",message:"bridge.userId missing in gateway mode",nextSteps:[`Set plugins.entries.kimi-claw.config.bridge.userId in ${e.openclawConfigPath}`]}),i};export function resolveConnectorConfigWithMeta(e){const i=e.pluginConfig??{},r=e.openclawConfig,o=e.openclawConfigPath??e.localConfigPath??DEFAULT_OPENCLAW_CONFIG_PATH,a=pickRequired([{source:"pluginConfig",value:readString(i.bridge?.url)}],{source:"default",value:DEFAULT_BRIDGE_URL}),l=pickRequired([{source:"pluginConfig",value:readString(i.bridge?.userId)}],{source:"default",value:""}),u=pickOptional([{source:"pluginConfig",value:readString(i.bridge?.token)}]),n=pickRequired([{source:"pluginConfig",value:readString(i.bridge?.kimiapiHost)}],{source:"default",value:DEFAULT_KIMIAPI_HOST}),t=pickRequired([{source:"pluginConfig",value:readString(i.bridge?.kimiFileDownloadDir)}],{source:"default",value:"./openclaw/kimi/downloads"}),s=pickTruthyNumber([{source:"pluginConfig",value:readNumber(i.bridge?.protocol)}],{source:"default",value:3}),c=pickRequired([{source:"pluginConfig",value:normalizeBridgeMode(i.bridge?.mode)}],{source:"default",value:"acp"}),d=pickRequired([{source:"pluginConfig",value:readString(i.bridge?.instanceId)}],{source:"default",value:`connector-${process.pid}`}),g=pickRequired([{source:"pluginConfig",value:readString(i.bridge?.deviceId)}],{source:"default",value:"unknown-device"}),p=pickRequired([{source:"pluginConfig",value:readBoolean(i.bridge?.forwardThinking)}],{source:"default",value:!1}),f=pickRequired([{source:"pluginConfig",value:readBoolean(i.bridge?.forwardToolCalls)}],{source:"default",value:!1}),v=pickRequired([{source:"pluginConfig",value:readInteger(i.bridge?.promptTimeoutMs)}],{source:"default",value:18e5}),_=Math.max(0,v.value),m=pickRequired([{source:"pluginConfig",value:readInteger(i.bridge?.historyPendingTimeoutMs)}],{source:"default",value:15e3}),L=Math.max(0,m.value),E=pickRequired([{source:"pluginConfig",value:readBoolean(i.bridge?.shell?.enabled)}],{source:"default",value:!1}),T=pickRequired([{source:"pluginConfig",value:readInteger(i.bridge?.shell?.maxConcurrentSessions)}],{source:"default",value:10}),A=pickRequired([{source:"pluginConfig",value:readInteger(i.bridge?.shell?.idleTimeoutMs)}],{source:"default",value:432e5}),D=pickRequired([{source:"pluginConfig",value:readInteger(i.bridge?.shell?.maxDurationMs)}],{source:"default",value:432e5}),I=pickRequired([{source:"pluginConfig",value:readString(i.bridge?.shell?.defaultShell)}],{source:"default",value:"/bin/bash"}),b=pickOptional([{source:"pluginConfig",value:readInteger(i.bridge?.terminalWs?.port)}]),k=pickRequired([{source:"pluginConfig",value:readString(i.bridge?.terminalWs?.host)}],{source:"default",value:"127.0.0.1"}),C=pickRequired([{source:"pluginConfig",value:readString(i.bridge?.terminalWs?.path)}],{source:"default",value:"/terminal"}),F=pickOptional([{source:"pluginConfig",value:readString(i.bridge?.terminalWs?.token)}]),R=pickOptional([{source:"pluginConfig",value:normalizeTerminalWsAllowedOrigins(i.bridge?.terminalWs?.allowedOrigins)}]),S=readBoolean(i.bridge?.terminalWs?.enabled),w=void 0!==S?{source:"pluginConfig",value:S}:void 0!==b.value?{source:b.source,value:!0}:{source:"default",value:!1},O=pickRequired([{source:"pluginConfig",value:readString(i.gateway?.url)}],{source:"default",value:DEFAULT_GATEWAY_URL}),M=pickOptional([{source:"openclawConfig",value:readString(r?.gateway?.auth?.token)},{source:"pluginConfig",value:readString(i.gateway?.token)}]),h=pickTruthyNumber([{source:"pluginConfig",value:readNumber(i.gateway?.protocol)}],{source:"default",value:3}),U=pickRequired([{source:"pluginConfig",value:readString(i.gateway?.clientId)}],{source:"default",value:"gateway-client"}),y=pickRequired([{source:"pluginConfig",value:readString(i.gateway?.clientMode)}],{source:"default",value:"backend"}),N=pickRequired([{source:"pluginConfig",value:readString(i.gateway?.agentId)}],{source:"default",value:"main"}),W=pickRequired([{source:"pluginConfig",value:readNumber(i.retry?.baseMs)}],{source:"default",value:1e3}),P=pickRequired([{source:"pluginConfig",value:readNumber(i.retry?.maxMs)}],{source:"default",value:6e5}),q=pickRequired([{source:"pluginConfig",value:readNumber(i.retry?.maxAttempts)}],{source:"default",value:0}),G=pickRequired([{source:"pluginConfig",value:readBoolean(i.log?.verbose)}],{source:"default",value:!1}),x=pickRequired([{source:"pluginConfig",value:readBoolean(i.log?.enabled)}],{source:"default",value:!1}),B=pickRequired([{source:"pluginConfig",value:readString(i.log?.forwardFile)}],{source:"default",value:DEFAULT_FORWARD_LOG_FILE}),H=pickRequired([{source:"pluginConfig",value:readString(i.log?.replyFile)}],{source:"default",value:DEFAULT_REPLY_LOG_FILE}),j=pickRequired([{source:"pluginConfig",value:readString(i.log?.allFile)}],{source:"default",value:DEFAULT_ALL_LOG_FILE}),z=pickRequired([{source:"pluginConfig",value:readString(i.log?.wsObsFile)}],{source:"default",value:DEFAULT_WS_OBS_LOG_FILE}),Y=pickOptional([{source:"pluginConfig",value:readString(i.log?.requestIdFilter)}]),K=pickOptional([{source:"pluginConfig",value:readString(i.log?.sessionIdFilter)}]),$=pickRequired([{source:"pluginConfig",value:normalizeTerminalPayloadMode(i.log?.terminalPayloadMode)}],{source:"default",value:"artifact"}),X=pickRequired([{source:"pluginConfig",value:readString(i.log?.terminalArtifactDir)}],{source:"default",value:"/tmp/openclaw_obs_artifacts"}),V=pickRequired([{source:"pluginConfig",value:readBoolean(i.defaultModel?.enabled)}],{source:"default",value:!1}),J=pickOptional([{source:"pluginConfig",value:readString(i.defaultModel?.apiKey)}]),Q=pickRequired([{source:"pluginConfig",value:readString(i.defaultModel?.provider)}],{source:"default",value:"kimi-coding"}),Z=pickRequired([{source:"pluginConfig",value:readString(i.defaultModel?.modelId)}],{source:"default",value:"k2p5"}),ee=pickRequired([{source:"pluginConfig",value:readString(i.defaultModel?.baseUrl)}],{source:"default",value:DEFAULT_MODEL_BASE_URL}),ie={bridge:{url:a.value,userId:l.value,token:u.value,kimiapiHost:n.value,kimiFileDownloadDir:t.value,protocol:s.value,mode:c.value,instanceId:d.value,deviceId:g.value,forwardThinking:p.value,forwardToolCalls:f.value,promptTimeoutMs:_,historyPendingTimeoutMs:L,shell:{enabled:E.value,maxConcurrentSessions:Math.max(1,T.value),idleTimeoutMs:Math.max(0,A.value),maxDurationMs:Math.max(0,D.value),defaultShell:I.value},terminalWs:{enabled:w.value,port:b.value??0,host:k.value,path:C.value,...F.value?{token:F.value}:{},...R.value?{allowedOrigins:R.value}:{}}},gateway:{url:O.value,token:M.value,protocol:h.value,clientId:U.value,clientMode:y.value,agentId:N.value},retry:{baseMs:W.value,maxMs:P.value,maxAttempts:q.value},log:{enabled:x.value,verbose:G.value,forwardFile:B.value,replyFile:H.value,allFile:j.value,wsObsFile:z.value,requestIdFilter:Y.value,sessionIdFilter:K.value,terminalPayloadMode:$.value,terminalArtifactDir:X.value},defaultModel:{enabled:V.value,provider:Q.value,modelId:Z.value,apiKey:J.value,baseUrl:ee.value}};return{config:ie,sources:{bridge:{url:a.source,userId:l.source,token:u.source,kimiapiHost:n.source,kimiFileDownloadDir:t.source,protocol:s.source,mode:c.source,instanceId:d.source,deviceId:g.source,forwardThinking:p.source,forwardToolCalls:f.source,promptTimeoutMs:v.source,historyPendingTimeoutMs:m.source,shell:{enabled:E.source,maxConcurrentSessions:T.source,idleTimeoutMs:A.source,maxDurationMs:D.source,defaultShell:I.source},terminalWs:{enabled:w.source,port:b.source,host:k.source,path:C.source,token:F.source,allowedOrigins:R.source}},gateway:{url:O.source,token:M.source,protocol:h.source,clientId:U.source,clientMode:y.source,agentId:N.source},retry:{baseMs:W.source,maxMs:P.source,maxAttempts:q.source},log:{enabled:x.source,verbose:G.source,forwardFile:B.source,replyFile:H.source,allFile:j.source,wsObsFile:z.source,requestIdFilter:Y.source,sessionIdFilter:K.source,terminalPayloadMode:$.source,terminalArtifactDir:X.source},defaultModel:{enabled:V.source,provider:Q.source,modelId:Z.source,apiKey:J.source,baseUrl:ee.source}},validation:validateResolvedConfig({config:ie,openclawConfigPath:o}),openclawConfigPath:o}}export function resolveConnectorConfig(e){return resolveConnectorConfigWithMeta(e).config}