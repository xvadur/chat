import{asTrimmedNonEmptyString as asString}from"./utils/text.js";import{dispatchToolResultToMessageBlocks}from"./tool-result-dispatcher.js";import{KIMI_UPLOAD_TOOL_NAME}from"./kimi-upload-tool.js";const isRecord=o=>!!o&&"object"==typeof o&&!Array.isArray(o),asRecordOrUndefined=o=>isRecord(o)?o:void 0,KIMI_UPLOAD_TOOL_RESULT_BLOCKS_STRATEGY={canHandle:(o,e)=>o===KIMI_UPLOAD_TOOL_NAME&&isRecord(e)&&!0===e.ok,toMessageBlocks:(o,e)=>{if(!isRecord(e))return[];const t=e.files;if(!Array.isArray(t))return[];const r=[];for(const o of t){if(!isRecord(o))continue;const e=asString(o.uri);if(!e)continue;const t=asString(o.name),s=asString(o.mimeType),n={type:"resource_link",uri:e,...t?{name:t}:{},...s?{mimeType:s}:{}};r.push(n)}return r}},maybeKimiUploadResultFromContent=o=>{if(!Array.isArray(o))return;const e=[];for(const t of o){if(!isRecord(t))continue;const o=asString(t.uri);if(!o)continue;const r=asString(t.type);if(r&&"resource_link"!==r)continue;const s={uri:o},n=asString(t.name),i=asString(t.mimeType);n&&(s.name=n),i&&(s.mimeType=i),e.push(s)}return e.length?{ok:!0,files:e}:void 0},KIMI_FILE_RESULT_STRATEGIES=[KIMI_UPLOAD_TOOL_RESULT_BLOCKS_STRATEGY],asRecord=o=>isRecord(o)?o:void 0,pickToolResultPayload=o=>{const e=asRecord(o.result);if(e)return e;const t=asRecord(o.output);if(t)return t;const r=asRecord(o.details);if(r)return r;return asRecordOrUndefined(o.content)||maybeKimiUploadResultFromContent(o.content)};export const buildToolResultSessionContentBlocks=(o,e)=>{const t=asRecord(e);if(!t)return[];const r=pickToolResultPayload(t);if(!r)return[];const s=dispatchToolResultToMessageBlocks(o,r,KIMI_FILE_RESULT_STRATEGIES);return s.length?s.map(o=>({type:"content",content:o})):[]};