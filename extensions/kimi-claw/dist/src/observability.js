import{homedir}from"node:os";import{join}from"node:path";import{createRollingJsonlWriter,DEFAULT_LOG_ROLLING_MAX_BYTES}from"./utils/rolling-jsonl.js";import{asTrimmedNonEmptyString as asNonEmptyString}from"./utils/text.js";const collectSecrets=t=>{const e=[],r=asNonEmptyString(t.bridgeToken),o=asNonEmptyString(t.gatewayToken);return r&&e.push(r),o&&e.push(o),Array.from(new Set(e)).sort((t,e)=>e.length-t.length)};export const redactTokens=(t,e)=>{const r=collectSecrets(e);if(0===r.length)return t;const o=new WeakMap,n=t=>{if(null==t||"boolean"==typeof t||"number"==typeof t)return t;if("string"==typeof t)return(t=>{let e=t;for(const t of r)t&&(t.length>=8?e=e.split(t).join("(redacted)"):e===t&&(e="(redacted)"));return e})(t);if(Array.isArray(t)){const e=o.get(t);if(e)return e;const r=[];o.set(t,r);for(const e of t)r.push(n(e));return r}if("object"!=typeof t)return t;const e=t,s=o.get(e);if(s)return s;const i=Object.create(Object.getPrototypeOf(e));o.set(e,i);for(const[t,r]of Object.entries(e))i[t]=n(r);return i};return n(t)};const DEFAULT_LOG_DIR=join(homedir(),".kimi","kimi-claw","log");export const DEFAULT_OBS_TRACE_FILE=join(DEFAULT_LOG_DIR,"openclaw_all_trace.log");export const createObsEventWriter=t=>{const e=t.filePath??DEFAULT_OBS_TRACE_FILE;if(!e.trim())return t=>{};const r=createRollingJsonlWriter({filePath:e,logger:t.logger,contextLabel:"obs",maxBytes:DEFAULT_LOG_ROLLING_MAX_BYTES}),o=t.redaction;return t=>{const e={...t,ts:asNonEmptyString(t.ts)??(new Date).toISOString()},n=o?redactTokens(e,o):e;r(n)}};