import{existsSync,mkdirSync,readdirSync,statSync,writeFileSync}from"node:fs";import path from"node:path";import{isPlainRecord as isRecord}from"../utils/json.js";import{asTrimmedNonEmptyString as asString}from"../utils/text.js";import{parseKimiFileResourceLinkUri}from"./prompt-converter.js";const MAX_KIMI_FILE_NAME_LENGTH=120,KIMI_BOT_TOKEN_HEADER="X-Kimi-Bot-Token";export class AcpGatewayKimiFileResolver{logger;kimiapiHost;kimiBotToken;kimiFileResolveTimeoutMs;kimiFileDownloadDir;fetchImpl;writeObsEvent;traceAll;constructor(e){this.logger=e.logger,this.kimiapiHost=e.kimiapiHost,this.kimiBotToken=e.kimiBotToken,this.kimiFileResolveTimeoutMs=e.kimiFileResolveTimeoutMs,this.kimiFileDownloadDir=e.kimiFileDownloadDir,this.fetchImpl=e.fetchImpl,this.writeObsEvent=e.writeObsEvent,this.traceAll=e.traceAll}buildResolutionPlan(e){const i=new Map;for(const t of e){if("resource_link"!==t.type||!t.uri)continue;const e=parseKimiFileResourceLinkUri(t.uri);if(e.error)return{fileIds:[],fileIdByUri:i,error:e.error};e.fileId&&i.set(t.uri,e.fileId)}return{fileIds:[...new Set(i.values())],fileIdByUri:i}}async resolveMetadataForPrompt(e,i,t){if(0===e.fileIds.length)return new Map;const s=new Map,a=await Promise.all(e.fileIds.map(async e=>[e,await this.resolveKimiFileMetadata(e,i,t)]));for(const[e,i]of a)s.set(e,i);const r=new Map;for(const[i,t]of e.fileIdByUri.entries()){const e=s.get(t);e&&r.set(i,e)}return r}redactUrlQuery(e){const i=e.trim();if(!i)return{url:i,queryRedacted:!1};try{const e=new URL(i),t=e.search.length>0;return e.search="",e.hash="",{url:e.toString(),queryRedacted:t}}catch{const e=i.includes("?");return{url:(e?i.split("?")[0]:i).split("#")[0]??"",queryRedacted:e}}}sanitizeKimiFileTracePayload(e){const i=new WeakMap,t=(e,s)=>{if(null==e||"boolean"==typeof e||"number"==typeof e)return e;if("string"==typeof e)return"signUrl"===s||"sign_url"===s?this.redactUrlQuery(e).url:e;if(Array.isArray(e)){const s=i.get(e);if(s)return s;const a=[];i.set(e,a);for(const i of e)a.push(t(i));return a}if("object"!=typeof e)return e;const a=e,r=i.get(a);if(r)return r;const l=Object.create(Object.getPrototypeOf(a));i.set(a,l);for(const[e,i]of Object.entries(a))l[e]=t(i,e);return l};return t(e)}async resolveKimiFileMetadata(e,i,t){const s=Date.now(),a=this.resolveKimiFileMetadataUrl(e),r={component:"connector",domain:"kimi_file",requestId:String(t),sessionId:i,sessionKey:i,hop:"plugin->kimi_file_api",where:"AcpGatewayBridge.resolveKimiFileMetadata"};this.writeObsEvent?.({...r,name:"kimi_file.metadata_request",severity:"info",summary:`kimi-file metadata request fileId=${e}`,payload:{fileId:e,url:a??null,timeoutMs:this.kimiFileResolveTimeoutMs}});const l=i=>{this.writeObsEvent?.({...r,name:"kimi_file.metadata_response",severity:i.severity,durationMs:Date.now()-s,summary:`kimi-file metadata response fileId=${e}${null!==i.httpStatus?` httpStatus=${i.httpStatus}`:""}${i.code?` code=${i.code}`:""}`,payload:{fileId:e,httpStatus:i.httpStatus,...i.code?{code:i.code}:{},...i.message?{message:i.message}:{},...void 0!==i.retriable?{retriable:i.retriable}:{},...i.downloadUrlSource?{downloadUrlSource:i.downloadUrlSource}:{},...i.downloadUrl?{downloadUrl:i.downloadUrl}:{},...void 0!==i.downloadUrlQueryRedacted?{downloadUrlQueryRedacted:i.downloadUrlQueryRedacted}:{}}})};if(!this.kimiBotToken)return l({severity:"warn",httpStatus:null,code:"token_missing",message:"bridge token is required to resolve kimi-file metadata",retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e,sessionId:i,requestId:t,code:"token_missing",message:"bridge token is required to resolve kimi-file metadata",retriable:!1});if(!a)return l({severity:"warn",httpStatus:null,code:"invalid_config",message:"kimiapiHost is invalid",retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e,sessionId:i,requestId:t,code:"invalid_config",message:"kimiapiHost is invalid",retriable:!1});const o=new AbortController,n=setTimeout(()=>{o.abort()},this.kimiFileResolveTimeoutMs);n.unref?.();try{const s={[KIMI_BOT_TOKEN_HEADER]:this.kimiBotToken??"",Accept:"application/json"};this.traceAll({ts:(new Date).toISOString(),trace:"kimi-file",stage:"metadata_request",fileId:e,sessionId:i,requestId:t,method:"GET",url:a,headers:{...s,[KIMI_BOT_TOKEN_HEADER]:"(redacted)"}});const r=await this.fetchImpl(a,{method:"GET",headers:s,signal:o.signal});if(!r.ok){const s=r.status>=500?"http_5xx":"http_4xx",a=r.status>=500||429===r.status;return this.traceAll({ts:(new Date).toISOString(),trace:"kimi-file",stage:"metadata_response_error",fileId:e,sessionId:i,requestId:t,httpStatus:r.status,code:s}),l({severity:"warn",httpStatus:r.status,code:s,message:`files api request failed with status ${r.status}`,retriable:a}),this.makeKimiFileResolutionFailure({fileId:e,sessionId:i,requestId:t,code:s,httpStatus:r.status,message:`files api request failed with status ${r.status}`,retriable:a})}let n;try{n=await r.json()}catch{return this.traceAll({ts:(new Date).toISOString(),trace:"kimi-file",stage:"metadata_response_error",fileId:e,sessionId:i,requestId:t,httpStatus:r.status,code:"invalid_response",message:"response is not valid json"}),l({severity:"warn",httpStatus:r.status,code:"invalid_response",message:"files api response is not valid json",retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e,sessionId:i,requestId:t,code:"invalid_response",message:"files api response is not valid json",retriable:!1})}if(this.traceAll({ts:(new Date).toISOString(),trace:"kimi-file",stage:"metadata_response_ok",fileId:e,sessionId:i,requestId:t,httpStatus:r.status,body:this.sanitizeKimiFileTracePayload(n)}),!isRecord(n))return l({severity:"warn",httpStatus:r.status,code:"invalid_response",message:"files api response must be an object",retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e,sessionId:i,requestId:t,code:"invalid_response",message:"files api response must be an object",retriable:!1});const d=asString(n.id);if(!d)return l({severity:"warn",httpStatus:r.status,code:"invalid_response",message:"files api response missing id",retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e,sessionId:i,requestId:t,code:"invalid_response",message:"files api response missing id",retriable:!1});const c=isRecord(n.meta)?n.meta:void 0;if(!c)return l({severity:"warn",httpStatus:r.status,code:"invalid_response",message:"files api response missing meta",retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e,sessionId:i,requestId:t,code:"invalid_response",message:"files api response missing meta",retriable:!1});const u=asString(c.name);if(!u)return l({severity:"warn",httpStatus:r.status,code:"invalid_response",message:"files api response missing meta.name",retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e,sessionId:i,requestId:t,code:"invalid_response",message:"files api response missing meta.name",retriable:!1});const m=asString(c.contentType)??asString(c.content_type);if(!m)return l({severity:"warn",httpStatus:r.status,code:"invalid_response",message:"files api response missing meta.contentType",retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e,name:u,sessionId:i,requestId:t,code:"invalid_response",message:"files api response missing meta.contentType",retriable:!1});const f=c.sizeBytes??c.size_bytes,h="number"==typeof f?f:"string"==typeof f&&/^\d+$/.test(f.trim())?Number(f.trim()):f,p=void 0===h?void 0:"number"==typeof h&&Number.isFinite(h)&&h>=0?Math.trunc(h):null;if(null===p)return l({severity:"warn",httpStatus:r.status,code:"invalid_response",message:"files api response has invalid meta.sizeBytes",retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e,name:u,sessionId:i,requestId:t,code:"invalid_response",message:"files api response has invalid meta.sizeBytes",retriable:!1});const I=isRecord(n.blob)?n.blob:void 0,g=asString(I?.signUrl)??asString(I?.sign_url),y=this.readKimiFilePreviewUrl(n),w=g??y,S=g?"blob.signUrl":y?"parseJob.result.image.thumbnail.previewUrl":void 0;if(!w||!S)return l({severity:"warn",httpStatus:r.status,code:"missing_download_url",message:"files api response missing blob.signUrl and image preview fallback url",retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e,name:u,sessionId:i,requestId:t,code:"missing_download_url",message:"files api response missing blob.signUrl and image preview fallback url",retriable:!1});const v=this.redactUrlQuery(w);l({severity:"info",httpStatus:r.status,downloadUrlSource:S,downloadUrl:v.url,downloadUrlQueryRedacted:v.queryRedacted});const k={status:"resolved",fileId:e,id:d,name:u,contentType:m,...void 0!==p?{sizeBytes:p}:{},downloadUrl:w,downloadUrlSource:S,localPath:"",localFileName:"",localSizeBytes:0,localCacheHit:!1},b=await this.ensureKimiFileDownloaded({fileId:e,name:u,downloadUrl:w,sessionId:i,requestId:t});return"status"in b&&"resolve_failed"===b.status?b:(k.localPath=b.localPath,k.localFileName=b.localFileName,k.localSizeBytes=b.localSizeBytes,k.localCacheHit=b.localCacheHit,this.logger.info(`[acp] kimi-file metadata resolved requestId=${String(t)} sessionId=${i} fileId=${e} source=${S} contentType=${m} sizeBytes=${String(p??"unknown")} localPath=${k.localPath} localSizeBytes=${String(k.localSizeBytes)} cacheHit=${String(k.localCacheHit)}`),k)}catch(s){const a=s instanceof Error?s.name:"",r="AbortError"===a?"timeout":"network_error",o="AbortError"===a?`files api request timed out after ${this.kimiFileResolveTimeoutMs}ms`:"files api request failed due to network error";return l({severity:"warn",httpStatus:null,code:r,message:o,retriable:"timeout"===r||"network_error"===r}),this.makeKimiFileResolutionFailure({fileId:e,sessionId:i,requestId:t,code:r,message:o,retriable:"timeout"===r||"network_error"===r})}finally{clearTimeout(n)}}resolveKimiFileMetadataUrl(e){try{const i=this.kimiapiHost.endsWith("/")?this.kimiapiHost:`${this.kimiapiHost}/`;return new URL(`files/${encodeURIComponent(e)}`,i).toString()}catch{return}}sanitizeKimiFileName(e){return path.basename(e).trim().replace(/[\u0000-\u001f\u007f]/g,"").replace(/[\\/]+/g,"_").replace(/[^\p{L}\p{N}._-]+/gu,"_").replace(/_+/g,"_").replace(/^\.+/,"").replace(/^_+|_+$/g,"").slice(0,120)||"file"}findExistingKimiFileDownload(e){if(!existsSync(this.kimiFileDownloadDir))return;const i=`${e}_`;let t;try{t=readdirSync(this.kimiFileDownloadDir,{withFileTypes:!0})}catch{return}const s=[...t].sort((e,i)=>e.name.localeCompare(i.name));for(const e of s){if(!e.isFile()||!e.name.startsWith(i))continue;const t=path.join(this.kimiFileDownloadDir,e.name);try{const i=statSync(t);if(!i.isFile()||i.size<=0)continue;return{localPath:t,localFileName:e.name,localSizeBytes:i.size}}catch{continue}}}async ensureKimiFileDownloaded(e){const i=Date.now(),t={component:"connector",domain:"kimi_file",requestId:String(e.requestId),sessionId:e.sessionId,sessionKey:e.sessionId,hop:"plugin->kimi_file_download",where:"AcpGatewayBridge.ensureKimiFileDownloaded"},s=this.redactUrlQuery(e.downloadUrl),a=(e,i)=>{this.writeObsEvent?.({...t,name:"kimi_file.download_request",severity:"info",summary:i,payload:e})},r=s=>{this.writeObsEvent?.({...t,name:"kimi_file.download_response",severity:s.severity,durationMs:Date.now()-i,summary:`kimi-file download response fileId=${e.fileId}${null!==s.httpStatus?` httpStatus=${s.httpStatus}`:""}${s.code?` code=${s.code}`:""}`,payload:{fileId:e.fileId,httpStatus:s.httpStatus,localPath:s.localPath,localSizeBytes:s.localSizeBytes,localCacheHit:s.localCacheHit,...s.code?{code:s.code}:{},...s.message?{message:s.message}:{},...void 0!==s.retriable?{retriable:s.retriable}:{}}})},l=`${e.fileId}_${this.sanitizeKimiFileName(e.name)}`,o=path.join(this.kimiFileDownloadDir,l);try{mkdirSync(this.kimiFileDownloadDir,{recursive:!0})}catch(i){return a({fileId:e.fileId,url:s.url,urlQueryRedacted:s.queryRedacted,localPath:o,localCacheHit:!1},`kimi-file download request fileId=${e.fileId}`),r({severity:"warn",httpStatus:null,localPath:o,localSizeBytes:null,localCacheHit:!1,code:"invalid_config",message:`failed to create kimi-file download dir ${this.kimiFileDownloadDir}: ${String(i)}`,retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e.fileId,name:e.name,sessionId:e.sessionId,requestId:e.requestId,code:"invalid_config",message:`failed to create kimi-file download dir ${this.kimiFileDownloadDir}: ${String(i)}`,retriable:!1})}const n=this.findExistingKimiFileDownload(e.fileId);if(n)return a({fileId:e.fileId,url:s.url,urlQueryRedacted:s.queryRedacted,localPath:n.localPath,localCacheHit:!0},`kimi-file download request fileId=${e.fileId} (cache_hit=true)`),r({severity:"info",httpStatus:null,localPath:n.localPath,localSizeBytes:n.localSizeBytes,localCacheHit:!0}),this.logger.info(`[acp] kimi-file cache hit requestId=${String(e.requestId)} sessionId=${e.sessionId} fileId=${e.fileId} localPath=${n.localPath} localSizeBytes=${String(n.localSizeBytes)}`),this.traceAll({ts:(new Date).toISOString(),trace:"kimi-file",stage:"download_cache_hit",fileId:e.fileId,sessionId:e.sessionId,requestId:e.requestId,localPath:n.localPath,localSizeBytes:n.localSizeBytes}),{...n,localCacheHit:!0};const d=new AbortController,c=setTimeout(()=>{d.abort()},this.kimiFileResolveTimeoutMs);c.unref?.();try{a({fileId:e.fileId,url:s.url,urlQueryRedacted:s.queryRedacted,localPath:o,localCacheHit:!1},`kimi-file download request fileId=${e.fileId}`),this.traceAll({ts:(new Date).toISOString(),trace:"kimi-file",stage:"download_request",fileId:e.fileId,sessionId:e.sessionId,requestId:e.requestId,method:"GET",url:s.url,localPath:o});const i=await this.fetchImpl(e.downloadUrl,{method:"GET",signal:d.signal});if(!i.ok){const t=i.status>=500?"http_5xx":"http_4xx",s=i.status>=500||429===i.status;return this.traceAll({ts:(new Date).toISOString(),trace:"kimi-file",stage:"download_response_error",fileId:e.fileId,sessionId:e.sessionId,requestId:e.requestId,httpStatus:i.status,code:t}),r({severity:"warn",httpStatus:i.status,localPath:o,localSizeBytes:null,localCacheHit:!1,code:t,message:`file download request failed with status ${i.status}`,retriable:s}),this.makeKimiFileResolutionFailure({fileId:e.fileId,name:e.name,sessionId:e.sessionId,requestId:e.requestId,code:t,message:`file download request failed with status ${i.status}`,retriable:s,httpStatus:i.status})}let t;try{t=Buffer.from(await i.arrayBuffer())}catch{return r({severity:"warn",httpStatus:i.status,localPath:o,localSizeBytes:null,localCacheHit:!1,code:"network_error",message:"file download read failed while reading response body",retriable:!0}),this.makeKimiFileResolutionFailure({fileId:e.fileId,name:e.name,sessionId:e.sessionId,requestId:e.requestId,code:"network_error",message:"file download read failed while reading response body",retriable:!0})}if(t.byteLength<=0)return r({severity:"warn",httpStatus:i.status,localPath:o,localSizeBytes:0,localCacheHit:!1,code:"invalid_response",message:"downloaded file payload is empty",retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e.fileId,name:e.name,sessionId:e.sessionId,requestId:e.requestId,code:"invalid_response",message:"downloaded file payload is empty",retriable:!1});try{writeFileSync(o,t)}catch(t){return r({severity:"warn",httpStatus:i.status,localPath:o,localSizeBytes:null,localCacheHit:!1,code:"invalid_config",message:`failed to persist downloaded file at ${o}: ${String(t)}`,retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e.fileId,name:e.name,sessionId:e.sessionId,requestId:e.requestId,code:"invalid_config",message:`failed to persist downloaded file at ${o}: ${String(t)}`,retriable:!1})}let n=t.byteLength;try{const t=statSync(o);if(!t.isFile()||t.size<=0)return r({severity:"warn",httpStatus:i.status,localPath:o,localSizeBytes:null,localCacheHit:!1,code:"invalid_response",message:`downloaded file was not persisted correctly at ${o}`,retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e.fileId,name:e.name,sessionId:e.sessionId,requestId:e.requestId,code:"invalid_response",message:`downloaded file was not persisted correctly at ${o}`,retriable:!1});n=t.size}catch(t){return r({severity:"warn",httpStatus:i.status,localPath:o,localSizeBytes:null,localCacheHit:!1,code:"invalid_response",message:`downloaded file verification failed at ${o}: ${String(t)}`,retriable:!1}),this.makeKimiFileResolutionFailure({fileId:e.fileId,name:e.name,sessionId:e.sessionId,requestId:e.requestId,code:"invalid_response",message:`downloaded file verification failed at ${o}: ${String(t)}`,retriable:!1})}return this.logger.info(`[acp] kimi-file download stored requestId=${String(e.requestId)} sessionId=${e.sessionId} fileId=${e.fileId} localPath=${o} localSizeBytes=${String(n)}`),r({severity:"info",httpStatus:i.status,localPath:o,localSizeBytes:n,localCacheHit:!1}),this.traceAll({ts:(new Date).toISOString(),trace:"kimi-file",stage:"download_response_ok",fileId:e.fileId,sessionId:e.sessionId,requestId:e.requestId,httpStatus:i.status,localPath:o,localSizeBytes:n}),{localPath:o,localFileName:l,localSizeBytes:n,localCacheHit:!1}}catch(i){const t=i instanceof Error?i.name:"",s="AbortError"===t?"timeout":"network_error",a="AbortError"===t?`file download timed out after ${this.kimiFileResolveTimeoutMs}ms`:"file download request failed due to network error";return r({severity:"warn",httpStatus:null,localPath:o,localSizeBytes:null,localCacheHit:!1,code:s,message:a,retriable:"timeout"===s||"network_error"===s}),this.makeKimiFileResolutionFailure({fileId:e.fileId,name:e.name,sessionId:e.sessionId,requestId:e.requestId,code:s,message:a,retriable:"timeout"===s||"network_error"===s})}finally{clearTimeout(c)}}readKimiFilePreviewUrl(e){const i=isRecord(e.parseJob)?e.parseJob:isRecord(e.parse_job)?e.parse_job:void 0;if(!i)return;const t=isRecord(i.result)?i.result:void 0;if(!t)return;const s=isRecord(t.image)?t.image:void 0;if(!s)return;const a=isRecord(s.thumbnail)?s.thumbnail:void 0;return a?asString(a.previewUrl)??asString(a.preview_url):void 0}makeKimiFileResolutionFailure(e){return this.logger.warn(`[acp] kimi-file resolve/download failed requestId=${String(e.requestId)} sessionId=${e.sessionId} fileId=${e.fileId} code=${e.code}${void 0!==e.httpStatus?` status=${e.httpStatus}`:""} message=${e.message}`),{status:"resolve_failed",fileId:e.fileId,...e.name?{name:e.name}:{},code:e.code,message:e.message,retriable:e.retriable,...void 0!==e.httpStatus?{httpStatus:e.httpStatus}:{}}}}