import{randomUUID}from"node:crypto";import{sanitizePromptPayload}from"../message-filter.js";import{isPlainRecord as isRecord}from"../utils/json.js";import{asTrimmedNonEmptyString as asString}from"../utils/text.js";import{extractPromptBlocks,parseKimiFileResourceLinkUri}from"./prompt-converter.js";const DEFAULT_PROTOCOL_VERSION=1,DEFAULT_MODE={id:"default",name:"Default",description:"Default agent mode"},MAIN_SESSION_KEY="agent:main:main",USER_MESSAGE_PREFIX="User Message From Kimi:",USER_MESSAGE_PREFIX_WITH_NEWLINE=`${USER_MESSAGE_PREFIX}\n`,SLASH_COMMAND_NAME_RE=/^[a-z0-9_-]+$/i,toJsonError=e=>({error:{code:-32600,message:e}}),toIso=e=>new Date(e).toISOString(),withUserMessagePrefix=e=>e.startsWith(USER_MESSAGE_PREFIX)?e:`${USER_MESSAGE_PREFIX_WITH_NEWLINE}${e}`,resolveStandaloneSlashCommandName=(e,t)=>{if(0===e.length)return;if(e.some(e=>"text"!==e.type))return;const s=t.trim();if(!s||s.includes("\n")||!s.startsWith("/"))return;const r=s.match(/^\/([^\s:]+)(?::|\s|$)/)?.[1]?.trim();return r&&!r.includes("/")&&SLASH_COMMAND_NAME_RE.test(r)?r.toLowerCase():void 0};export const sanitizeObsMappingPayload=e=>{const t=/^[A-Za-z0-9+/]*={0,2}$/,s=new Set(["content","data","dataBase64"]),r=new WeakMap,i=e=>({_obs:{omitted:!0,kind:"base64",length:e.length}}),o=(e,n)=>{if(null==e||"boolean"==typeof e||"number"==typeof e)return e;if("string"==typeof e)return n&&s.has(n)&&e.length>1024||e.length>1024&&e.length%4==0&&t.test(e)?i(e):e;if(Array.isArray(e)){const t=r.get(e);if(t)return t;const s=[];r.set(e,s);for(const t of e)s.push(o(t));return s}if("object"!=typeof e)return e;const a=e,d=r.get(a);if(d)return d;const m=Object.create(Object.getPrototypeOf(a));r.set(a,m);for(const[e,t]of Object.entries(a))m[e]=o(t,e);return m};return o(e)};export class AcpGatewayBridgeCore{logger;instanceMeta;agentId;state;historyReplay;promptConverter;kimiFileResolver;isGatewayReady;sendGatewayFrame;writeObsEvent;forceRealtimeVerbose;forceReasoningStream;forwardThinkingToBridge;forwardToolCallsToBridge;promptTimeoutMs;sendSessionUpdate;sendResult;sendError;getCurrentAssistantStream;webSshEnabled;constructor(e){this.logger=e.logger,this.instanceMeta=e.instanceMeta,this.agentId=e.agentId,this.state=e.state,this.historyReplay=e.historyReplay,this.promptConverter=e.promptConverter,this.kimiFileResolver=e.kimiFileResolver,this.isGatewayReady=e.isGatewayReady,this.sendGatewayFrame=e.sendGatewayFrame,this.writeObsEvent=e.writeObsEvent,this.forceRealtimeVerbose=e.forceRealtimeVerbose,this.forceReasoningStream=e.forceReasoningStream,this.forwardThinkingToBridge=e.forwardThinkingToBridge,this.forwardToolCallsToBridge=e.forwardToolCallsToBridge,this.promptTimeoutMs=e.promptTimeoutMs,this.sendSessionUpdate=e.sendSessionUpdate,this.sendResult=e.sendResult,this.sendError=e.sendError,this.getCurrentAssistantStream=e.getCurrentAssistantStream,this.webSshEnabled=!0===e.webSshEnabled}handleBridgeMessage(e){if(!isRecord(e))return;const t=asString(e.method);if(!t)return;const s={jsonrpc:asString(e.jsonrpc),method:t,params:e.params};"string"!=typeof e.id&&"number"!=typeof e.id||(s.id=e.id),this.handleRequest(s)}handleGatewayDisconnected(){const e=this.state.getInFlightPrompts(),t=this.state.pendingHistoryRequests.size;for(const t of e)this.failPrompt(t,-32001,"gateway disconnected");for(const[e,t]of this.state.pendingHistoryRequests.entries())this.state.deletePendingHistoryRequest(e),t.onComplete&&void 0!==t.requestId&&this.sendError(t.requestId,-32001,"gateway disconnected",void 0,t.sessionId);(e.length||t)&&this.logger.warn(`[acp] gateway disconnected; failed in-flight prompts=${e.length} pending-history=${t}`)}completePrompt(e,t){e.done||(e.done=!0,this.sendResult(e.rpcId,{stopReason:t},e.sessionId),this.cleanupPrompt(e))}failPrompt(e,t,s,r){e.done||(e.done=!0,this.sendError(e.rpcId,t,s,r,e.sessionId),this.cleanupPrompt(e))}handleRequest(e){const t=e.id;if(void 0!==t||"session/cancel"===e.method)switch(e.method){case"initialize":if(void 0===t)return;return void this.sendResult(t,this.buildInitializeResult(e.params));case"session/new":if(void 0===t)return;return void this.handleSessionNew(t,e.params);case"session/load":if(void 0===t)return;return void this.handleSessionLoad(t,e.params);case"session/list":if(void 0===t)return;return void this.handleSessionList(t);case"session/prompt":if(void 0===t)return;return void this.handleSessionPrompt(t,e.params);case"session/cancel":return void this.handleSessionCancel(t,e.params);case"session/set_model":if(void 0===t)return;return void this.sendResult(t,{});default:void 0!==t&&this.sendError(t,-32601,`method not found: ${e.method}`)}}buildInitializeResult(e){const t=isRecord(e)&&"number"==typeof e.protocolVersion&&Number.isFinite(e.protocolVersion)?e.protocolVersion:void 0,s=1===t?t:1;void 0!==t&&1!==t&&this.logger.warn(`[acp] unsupported initialize protocolVersion=${t}; using 1`);const r=asString(this.instanceMeta.instanceId)??"connector-instance",i=asString(this.instanceMeta.deviceId)??r,o=asString(this.instanceMeta.pluginVersion)??"0.2.0";return{protocolVersion:s,agentCapabilities:{loadSession:!0,promptCapabilities:{embeddedContext:!0,image:!0,audio:!1},sessionCapabilities:{list:{},"web-ssh":this.webSshEnabled}},agentInfo:{name:"kimi-claw",version:o},_meta:{instanceId:r,deviceId:i}}}handleSessionNew(e,t){if(!isRecord(t))return void this.sendError(e,-32602,"invalid params",toJsonError("params must be object"));const s=this.parseSessionNewParams(t);if("error"in s)return void this.sendError(e,-32602,"invalid params",toJsonError(s.error));const{cwd:r}=s,i=MAIN_SESSION_KEY;this.state.upsertSession(i,r),this.sendResult(e,{sessionId:i,modes:{availableModes:[{...DEFAULT_MODE}],currentModeId:DEFAULT_MODE.id},_meta:{sessionKey:i,instanceId:this.instanceMeta.instanceId}},i),this.fetchHistory(i,void 0,e)}handleSessionLoad(e,t){if(!isRecord(t))return void this.sendError(e,-32602,"invalid params");if(!asString(t.sessionId))return void this.sendError(e,-32602,"sessionId is required");const s=MAIN_SESSION_KEY;this.state.upsertSession(s);const r=this.historyReplay.replaySessionLoad(s,e);this.logger.info(`[acp] session/load local replay sessionId=${s} count=${r}`),this.replayCurrentAssistantStream(s,e).catch(e=>{this.logger.warn(`[acp] session/load replayCurrentAssistantStream error sessionId=${s} error=${String(e)}`)}).finally(()=>{this.sendResult(e,null,s)})}async replayCurrentAssistantStream(e,t){const s=this.getCurrentAssistantStream?.();if(!s)return;let r=0;for(;;){const i=await s.read(r);if(null===i)break;for(const s of i){const i=void 0===s.ts?t:{requestId:t,messageType:"normal",timestamp:s.ts};this.historyReplay.sendSessionUpdate(e,s.data,i),r++}}}handleSessionList(e){const t=[...this.state.sessions.values()].sort((e,t)=>t.updatedAt-e.updatedAt).map(e=>({sessionId:e.id,cwd:e.cwd,title:"OpenClaw Session",updatedAt:toIso(e.updatedAt)}));this.sendResult(e,{sessions:t,nextCursor:null})}handleSessionPrompt(e,t){if(!isRecord(t))return void this.sendError(e,-32602,"invalid params");if(!asString(t.sessionId))return void this.sendError(e,-32602,"sessionId is required");const s=MAIN_SESSION_KEY,r=this.state.sessions.get(s)??this.state.upsertSession(s);if(!this.isGatewayReady())return this.writeObsEvent?.({component:"connector",domain:"transport",name:"transport.degrade",severity:"warn",requestId:String(e),sessionId:s,sessionKey:s,hop:"plugin->openclaw_gateway",where:"AcpGatewayBridgeCore.handleSessionPrompt",summary:"gateway not ready; session/prompt not forwarded",payload:{reason:"gateway_not_ready",direction:"plugin->openclaw_gateway",method:"session/prompt"}}),void this.sendError(e,-32001,"gateway unavailable");const i={id:e,method:"session/prompt",params:t},o=extractPromptBlocks(sanitizePromptPayload(t.prompt)),n=this.kimiFileResolver.buildResolutionPlan(o);if(void 0!==n.error)return void this.sendError(e,-32602,"invalid params",toJsonError(n.error));if(n.fileIds.length>0)return void this.handleSessionPromptWithKimiFileResolution(e,r,s,o,n,i);const a=this.promptConverter.toGatewayPrompt(o);"error"in a?this.sendError(e,-32602,"invalid params",toJsonError(a.error)):this.forwardPromptToGateway(e,r,s,o,a,i)}async handleSessionPromptWithKimiFileResolution(e,t,s,r,i,o){const n=await this.kimiFileResolver.resolveMetadataForPrompt(i,s,e),a=this.promptConverter.toGatewayPrompt(r,{kimiFileResolutionsByUri:n,traceContext:{sessionId:s,requestId:e}});"error"in a?this.sendError(e,-32602,"invalid params",toJsonError(a.error)):this.forwardPromptToGateway(e,t,s,r,a,o)}forwardPromptToGateway(e,t,s,r,i,o){if(i.kimiFileResolutions.length>0){const t=i.kimiFileResolutions.map(e=>"resolved"===e.status?`${e.fileId}:resolved:${e.downloadUrlSource}`:`${e.fileId}:resolve_failed:${e.code}`).join(",");this.logger.info(`[acp] kimi-file metadata summary requestId=${String(e)} sessionId=${s} items=${t}`)}this.maybeSendRealtimeSettingsPatch(s);const n=resolveStandaloneSlashCommandName(r,i.message),a="string"==typeof n;a&&this.logger.info(`[acp] slash command passthrough requestId=${String(e)} sessionId=${s} command=/${n}`);const d=a?"chat.send":"agent",m=a?i.message:withUserMessagePrefix(i.message),l=i.attachments,p=`req_${randomUUID().replace(/-/g,"")}`,u=`acp_${s}_${Date.now()}`,c={type:"req",id:p,method:d,params:a?{sessionKey:s,message:m,deliver:!1,idempotencyKey:u}:{agentId:this.agentId,sessionKey:s,message:m,...l.length?{attachments:l}:{},deliver:!1,idempotencyKey:u}},h=this.forwardThinkingToBridge,g=this.forwardToolCallsToBridge;if(this.writeObsEvent?.({component:"connector",domain:"mapping",name:"mapping.prompt_to_gateway_agent",severity:"info",requestId:String(e),sessionId:s,sessionKey:s,hop:"bridge_ws->plugin",where:"AcpGatewayBridge.forwardPromptToGateway",summary:`ACP session/prompt -> gateway ${d} (forwardThinking=${h} forwardToolCalls=${g})`,before:sanitizeObsMappingPayload(o),after:sanitizeObsMappingPayload(c),payload:{gatewayRequestId:p,gatewayMethod:d,forwardThinking:h,forwardToolCalls:g,slashCommandPassthrough:a,...n?{slashCommand:`/${n}`}:{}}}),!this.sendGatewayFrame(c))return void this.sendError(e,-32001,"failed to send prompt to gateway");this.emitPromptAsUserSessionUpdates(s,r,e,i.kimiFileResolutions),this.sendSessionUpdate(s,{sessionUpdate:"agent_message_chunk",content:{type:"text",text:""}},e),t.activePromptGatewayRequestId||(t.activePromptGatewayRequestId=p),t.updatedAt=Date.now();const f={sessionId:s,rpcId:e,gatewayRequestId:p,gatewayMethod:d,startedAt:Date.now(),done:!1,hasAgentAssistantStream:!1,hasAgentThinkingStream:!1,hasAgentToolStartStream:!1,hasAgentToolResultStream:!1,chatReplayDedupKeys:new Set,nextGeneratedToolCallId:0,pendingGeneratedToolCallIds:[],toolCallIdsByIncomingId:new Map,chatAssistantTextSoFar:""};this.state.addPromptRun(f),this.schedulePromptTimeout(f)}emitPromptAsUserSessionUpdates(e,t,s,r){const i=new Map,o=Date.now();for(const e of r)"resolved"!==e.status?e.name&&i.set(e.fileId,e.name):i.set(e.fileId,e.name);for(const r of t){const t=this.toUserSessionUpdateContent(r,i);if(!t)continue;const n={requestId:s,timestamp:o};this.sendSessionUpdate(e,{sessionUpdate:"user_message_chunk",content:t},n)}}toUserSessionUpdateContent(e,t){if("text"===e.type){if(!e.text)return;return{type:"text",text:e.text}}if("image"===e.type){const t=e.mimeType??e.mime_type??"application/octet-stream",s=e.fileName??e.file_name??e.name;if(!e.data&&!e.uri)return;return{type:"image",...e.data?{data:e.data}:{},...e.uri?{uri:e.uri}:{},...t?{mimeType:t}:{},...s?{fileName:s}:{}}}if("resource_link"===e.type){if(!e.uri)return;const s=e.mimeType??e.mime_type,r=parseKimiFileResourceLinkUri(e.uri),i=e.name??(r.fileId?t.get(r.fileId):void 0);return{type:"resource_link",uri:e.uri,...e.title?{title:e.title}:{},...i?{name:i}:{},...s?{mimeType:s}:{}}}if("file"===e.type){const t=e.mimeType??e.mime_type??"application/octet-stream",s=e.fileName??e.file_name??e.filename??e.name;if(!e.data&&!e.text&&!e.uri)return;return{type:"file",...e.data?{data:e.data}:{},...e.text?{text:e.text}:{},...e.uri?{uri:e.uri}:{},...t?{mimeType:t}:{},...s?{fileName:s}:{}}}if("resource"===e.type){const t=e.resource??{},s=t.uri??e.uri,r=t.mimeType??t.mime_type??e.mimeType??e.mime_type,i=t.text??e.text,o=t.data??e.data,n=t.fileName??t.file_name??t.filename??t.name??e.fileName??e.file_name??e.filename??e.name;if(!s&&!i&&!o)return;return{type:"resource",resource:{...s?{uri:s}:{},...r?{mimeType:r}:{},...i?{text:i}:{},...o?{data:o}:{},...n?{fileName:n}:{}}}}}schedulePromptTimeout(e){this.promptTimeoutMs<=0||(e.timeoutTimer=setTimeout(()=>{e.done||(this.logger.warn(`[acp] prompt timeout waiting lifecycle sessionId=${e.sessionId} requestId=${String(e.rpcId)} gatewayRequestId=${e.gatewayRequestId} timeout_ms=${this.promptTimeoutMs}`),this.failPrompt(e,-32022,"gateway lifecycle timeout",{timeoutMs:this.promptTimeoutMs,requestId:e.gatewayRequestId,...e.runId?{runId:e.runId}:{}}))},this.promptTimeoutMs),e.timeoutTimer.unref?.())}maybeSendRealtimeSettingsPatch(e){if(!this.forceRealtimeVerbose&&!this.forceReasoningStream)return;if(!this.isGatewayReady())return;const t={key:e};this.forceRealtimeVerbose&&(t.verboseLevel="full"),this.forceReasoningStream&&(t.reasoningLevel="stream");const s={type:"req",id:`sess_patch_${randomUUID().replace(/-/g,"")}`,method:"sessions.patch",params:t};this.sendGatewayFrame(s)||this.logger.warn(`[acp] failed to send realtime session patch sessionId=${e}`)}handleSessionCancel(e,t){if(!isRecord(t))return void(void 0!==e&&this.sendError(e,-32602,"invalid params"));if(!asString(t.sessionId))return void(void 0!==e&&this.sendError(e,-32602,"sessionId is required"));const s=MAIN_SESSION_KEY,r=asString(t.requestId)??asString(t.request_id),i=asString(t.runId)??asString(t.run_id);let o=r?this.state.promptsByGatewayRequestId.get(r):void 0;!o&&i&&(o=this.state.promptsByRunId.get(i));const n=this.state.sessions.get(s),a=o?.gatewayRequestId??n?.activePromptGatewayRequestId??[...this.state.promptsByGatewayRequestId.values()].find(e=>e.sessionId===s&&!e.done)?.gatewayRequestId;if(!o&&a&&(o=this.state.promptsByGatewayRequestId.get(a)),!n&&!o)return void(void 0!==e&&this.sendError(e,-32602,"unknown sessionId"));const d=o?.gatewayRequestId??r,m=o?.runId??i;if(d||m){const e={sessionKey:s};m&&(e.runId=m),d&&(e.requestId=d);const t={type:"req",id:`cancel_${d??m??s}`,method:"agent.cancel",params:e};this.sendGatewayFrame(t)}o&&!o.done&&this.completePrompt(o,"cancelled"),void 0!==e&&this.sendResult(e,{},s)}fetchHistory(e,t,s){this.historyReplay.fetchHistory(e,t,s)}parseSessionNewParams(e){const t=this.readOptionalNonEmptyString(e,"cwd");if(t.error)return{error:t.error};const s=this.resolveNewSessionId(e);return"error"in s?s:{sessionId:s.sessionId,cwd:t.value??"."}}resolveNewSessionId(e){const t=this.readOptionalNonEmptyString(e,"sessionId");if(t.error)return{error:t.error};if(t.value)return{sessionId:t.value};if(!isRecord(e._meta))return{sessionId:`sess_${randomUUID().replace(/-/g,"")}`};const s=e._meta,r=this.readOptionalNonEmptyString(s,"sessionId");if(r.error)return{error:r.error};if(r.value)return{sessionId:r.value};const i=this.readOptionalNonEmptyString(s,"sessionKey");if(i.error)return{error:i.error};if(i.value)return{sessionId:i.value};if(!isRecord(s.openclaw))return{sessionId:`sess_${randomUUID().replace(/-/g,"")}`};const o=this.readOptionalNonEmptyString(s.openclaw,"sessionId");if(o.error)return{error:o.error};if(o.value)return{sessionId:o.value};const n=this.readOptionalNonEmptyString(s.openclaw,"sessionKey");return n.error?{error:n.error}:n.value?{sessionId:n.value}:{sessionId:`sess_${randomUUID().replace(/-/g,"")}`}}readOptionalNonEmptyString(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))return{};const s=e[t];if("string"!=typeof s)return{error:`${t} must be a string`};const r=s.trim();return r?{value:r}:{error:`${t} must be a non-empty string`}}cleanupPrompt(e){this.state.cleanupPromptRun(e)}}