import{asTrimmedNonEmptyString as asString}from"../utils/text.js";export class AcpGatewaySessionState{sessions=new Map;promptsByGatewayRequestId=new Map;promptsByRunId=new Map;pendingHistoryRequests=new Map;metaIndex=0;getInFlightPrompts(){return[...this.promptsByGatewayRequestId.values()].filter(e=>!e.done)}upsertSession(e,t){const s=Date.now(),i=this.sessions.get(e),n={id:e,cwd:t??i?.cwd??".",createdAt:i?.createdAt??s,updatedAt:s,activePromptGatewayRequestId:i?.activePromptGatewayRequestId};return this.sessions.set(e,n),n}addPromptRun(e){this.promptsByGatewayRequestId.set(e.gatewayRequestId,e)}bindPromptRunToRunId(e,t){e.runId=t,this.promptsByRunId.set(t,e)}resolvePromptRun(e){const t=asString(e.runId);if(t){const e=this.promptsByRunId.get(t);if(e)return e}const s=asString(e.requestId)??asString(e.request_id);if(s){const e=this.promptsByGatewayRequestId.get(s);if(e)return e}}hasPendingHistoryRequest(e){return this.pendingHistoryRequests.has(e)}setPendingHistoryRequest(e,t){const s=this.pendingHistoryRequests.get(e);this.clearPendingHistoryTimer(s),this.pendingHistoryRequests.set(e,t)}takePendingHistoryRequest(e){const t=this.pendingHistoryRequests.get(e);return this.pendingHistoryRequests.delete(e),this.clearPendingHistoryTimer(t),t}deletePendingHistoryRequest(e){const t=this.pendingHistoryRequests.get(e);this.pendingHistoryRequests.delete(e),this.clearPendingHistoryTimer(t)}cleanupPromptRun(e){e.timeoutTimer&&(clearTimeout(e.timeoutTimer),e.timeoutTimer=void 0),this.promptsByGatewayRequestId.delete(e.gatewayRequestId),e.runId&&this.promptsByRunId.delete(e.runId);const t=this.sessions.get(e.sessionId);if(t){if(t.activePromptGatewayRequestId===e.gatewayRequestId&&(t.activePromptGatewayRequestId=void 0),!t.activePromptGatewayRequestId){const s=[...this.promptsByGatewayRequestId.values()].find(t=>t.sessionId===e.sessionId&&!t.done);s&&(t.activePromptGatewayRequestId=s.gatewayRequestId)}t.updatedAt=Date.now()}}peekNextMetaIndex(){return this.metaIndex+1}nextMetaIndex(){return this.metaIndex+=1,this.metaIndex}clearPendingHistoryTimer(e){e?.timeoutTimer&&(clearTimeout(e.timeoutTimer),e.timeoutTimer=void 0)}}