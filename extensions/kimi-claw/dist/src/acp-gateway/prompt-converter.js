import path from"node:path";import{stripTransportMetadata}from"../message-filter.js";import{isPlainRecord as isRecord}from"../utils/json.js";import{asTrimmedNonEmptyString as asString}from"../utils/text.js";const KIMI_FILE_URI_PREFIX="kimi-file://",KIMI_FILE_ID_PATTERN=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/,truncate=(e,t)=>e.length<=t?e:`${e.slice(0,t)}...`,escapeXmlAttribute=e=>e.replace(/&/g,"&amp;").replace(/\"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),asPromptBlock=e=>{if(!isRecord(e)||"string"!=typeof e.type)return null;switch(e.type){case"text":return{type:"text",text:asString(e.text)??""};case"image":return{type:"image",data:asString(e.data),mimeType:asString(e.mimeType),mime_type:asString(e.mime_type),uri:asString(e.uri),fileName:asString(e.fileName),file_name:asString(e.file_name),name:asString(e.name)};case"file":return{type:"file",data:asString(e.data),text:asString(e.text),mimeType:asString(e.mimeType),mime_type:asString(e.mime_type),uri:asString(e.uri),fileName:asString(e.fileName),file_name:asString(e.file_name),filename:asString(e.filename),name:asString(e.name)};case"resource_link":return{type:"resource_link",uri:asString(e.uri),title:asString(e.title),name:asString(e.name),mimeType:asString(e.mimeType),mime_type:asString(e.mime_type)};case"resource":return{type:"resource",resource:isRecord(e.resource)?{uri:asString(e.resource.uri),mimeType:asString(e.resource.mimeType),mime_type:asString(e.resource.mime_type),text:asString(e.resource.text),data:asString(e.resource.data),fileName:asString(e.resource.fileName),file_name:asString(e.resource.file_name),filename:asString(e.resource.filename),name:asString(e.resource.name)}:void 0,uri:asString(e.uri),mimeType:asString(e.mimeType),mime_type:asString(e.mime_type),text:asString(e.text),data:asString(e.data),fileName:asString(e.fileName),file_name:asString(e.file_name),filename:asString(e.filename),name:asString(e.name)};default:return null}};export const extractPromptBlocks=e=>{const t=[];return Array.isArray(e)?t.push(...e):"string"==typeof e?t.push({type:"text",text:e}):isRecord(e)&&Array.isArray(e.content)?t.push(...e.content):isRecord(e)&&"string"==typeof e.type&&t.push(e),t.map(e=>asPromptBlock(e)).filter(e=>!!e)};export const resolveUriFileName=e=>{try{const t=new URL(e),i=path.basename(t.pathname);if(i&&"."!==i&&"/"!==i&&"\\"!==i)return decodeURIComponent(i)}catch{}const t=path.basename(e);if(t&&"."!==t&&"/"!==t&&"\\"!==t)return t};export const parseKimiFileResourceLinkUri=e=>{if(!e.startsWith("kimi-file://"))return{};const t=e.slice(12).trim();return t?KIMI_FILE_ID_PATTERN.test(t)?{fileId:t}:{error:"resource_link kimi-file uri has invalid file_id"}:{error:"resource_link kimi-file uri requires file_id"}};const getKimiFileFailureReason=e=>"http_4xx"!==e.code&&"http_5xx"!==e.code||void 0===e.httpStatus?e.code:`http_${e.httpStatus}`,buildKimiFileRefText=e=>`<KIMI_REF type="file" path="${escapeXmlAttribute(e.localPath)}" name="${escapeXmlAttribute(e.name)}" id="${escapeXmlAttribute(e.fileId)}" />`,buildKimiFileFailedRefText=e=>`<KIMI_REF type="file" path="" name="${escapeXmlAttribute(e.name)}" id="${escapeXmlAttribute(e.fileId)}" status="download_failed" reason="${escapeXmlAttribute(e.reason)}" />`;export class AcpGatewayPromptConverter{logger;constructor(e){this.logger=e.logger}toGatewayPrompt(e,t){const i=[],a=[],r=[],s=[],n=new Set;for(const m of e){if("text"===m.type){const e=stripTransportMetadata(m.text);e&&(i.push(e),a.push({type:"text",text:e}));continue}if("image"===m.type){const e=m.mimeType??m.mime_type??"application/octet-stream";if(!m.data&&!m.uri)return{error:"image block requires data or uri"};const t=m.fileName??m.file_name??m.name??(m.uri?resolveUriFileName(m.uri):void 0),s=[`mime=${e}`],n={type:"image",mimeType:e,...t?{fileName:t}:{}};m.data&&(s.push(`size=${m.data.length}`),n.data=m.data,this.pushGatewayAttachment(r,{type:"image",content:m.data,mimeType:e,fileName:t})),m.uri&&(s.push(`uri=${m.uri}`),n.uri=m.uri),i.push(`[image ${s.join(" ")}]`),a.push(n);continue}if("resource_link"===m.type){const e=m.uri;if(!e)return{error:"resource_link block requires uri"};const r=m.mimeType??m.mime_type,o=t?.traceContext,l=parseKimiFileResourceLinkUri(e);if(l.error)return{error:l.error};const u=t?.kimiFileResolutionsByUri?.get(e);if(u){const e="resolved"===u.status?`${u.fileId}:resolved`:`${u.fileId}:${u.code}`;n.has(e)||(n.add(e),s.push(u))}if(l.fileId&&"resolved"===u?.status){const e=buildKimiFileRefText({fileId:l.fileId,name:u.name,localPath:u.localPath});i.push(e),a.push({type:"text",text:e,kimiFile:this.toKimiFileResolutionRecord(u)}),o&&this.logger.info(`[acp] kimi-file converted to KIMI_REF requestId=${String(o.requestId)} sessionId=${o.sessionId} fileId=${l.fileId} status=resolved localPath=${u.localPath}`);continue}if(l.fileId&&"resolve_failed"===u?.status){const e=getKimiFileFailureReason(u),t=u.name??("string"==typeof m.name&&m.name.trim()?m.name.trim():"string"==typeof m.title&&m.title.trim()?m.title.trim():l.fileId),r=buildKimiFileFailedRefText({fileId:l.fileId,name:t,reason:e});i.push(r),a.push({type:"text",text:r,kimiFile:this.toKimiFileResolutionRecord(u)}),o&&this.logger.warn(`[acp] kimi-file converted to degraded KIMI_REF requestId=${String(o.requestId)} sessionId=${o.sessionId} fileId=${l.fileId} status=download_failed reason=${e}`);continue}const p=m.title??m.name??"resource";i.push(`[resource_link title=${p} uri=${e}]`),a.push({type:"resource_link",uri:e,...m.title?{title:m.title}:{},...m.name?{name:m.name}:{},...r?{mimeType:r}:{},...u?{kimiFile:this.toKimiFileResolutionRecord(u)}:{}});continue}if("file"===m.type){const e=m.mimeType??m.mime_type??"application/octet-stream",t=m.fileName??m.file_name??m.filename??m.name??(m.uri?resolveUriFileName(m.uri):void 0),s=m.text?stripTransportMetadata(m.text):void 0,n=s?Buffer.from(s,"utf-8").toString("base64"):void 0;if(!m.data&&!n&&!m.uri)return{error:"file block requires data, text, or uri"};const o=[`mime=${e}`,...t?[`name=${t}`]:[]],l={type:"file",mimeType:e,...t?{fileName:t}:{}};m.data?(o.push(`size=${m.data.length}`),l.data=m.data,this.pushGatewayAttachment(r,{type:"file",content:m.data,mimeType:e,fileName:t})):n&&(o.push(`text=${truncate(s??"",80)}`),l.text=s,this.pushGatewayAttachment(r,{type:"file",content:n,mimeType:e,fileName:t})),m.uri&&(o.push(`uri=${m.uri}`),l.uri=m.uri),i.push(`[file ${o.join(" ")}]`),a.push(l);continue}if("resource"===m.type){const e=m.resource??{},t=e.uri??m.uri;if(!t)return{error:"resource block requires uri"};const s=e.mimeType??e.mime_type??m.mimeType??m.mime_type,n=e.text??m.text?stripTransportMetadata(e.text??m.text??""):void 0,o=e.data??m.data,l=e.fileName??e.file_name??e.filename??e.name??m.fileName??m.file_name??m.filename??m.name??resolveUriFileName(t);a.push({type:"resource",uri:t,...s?{mimeType:s}:{},...n?{text:n}:{},...o?{data:o}:{},...l?{fileName:l}:{}}),o?this.pushGatewayAttachment(r,{type:"file",content:o,mimeType:s,fileName:l}):n&&this.pushGatewayAttachment(r,{type:"file",content:Buffer.from(n,"utf-8").toString("base64"),mimeType:s??"text/plain",fileName:l}),n?i.push(`[resource uri=${t}${s?` mime=${s}`:""} text=${truncate(n,120)}]`):o?i.push(`[resource uri=${t}${s?` mime=${s}`:""} size=${o.length}]`):i.push(`[resource uri=${t}${s?` mime=${s}`:""}]`)}}return i.length?{message:i.join("\n"),inputBlocks:a,attachments:r,kimiFileResolutions:s}:{message:"(empty prompt)",inputBlocks:[],attachments:[],kimiFileResolutions:[]}}pushGatewayAttachment(e,t){t.content&&e.push({type:t.type,content:t.content,...t.mimeType?{mimeType:t.mimeType}:{},...t.fileName?{fileName:t.fileName}:{}})}toKimiFileResolutionRecord(e){return"resolved"===e.status?{status:e.status,fileId:e.fileId,id:e.id,name:e.name,contentType:e.contentType,...void 0!==e.sizeBytes?{sizeBytes:e.sizeBytes}:{},downloadUrlSource:e.downloadUrlSource,localPath:e.localPath,localFileName:e.localFileName,localSizeBytes:e.localSizeBytes,localCacheHit:e.localCacheHit}:{status:e.status,fileId:e.fileId,...e.name?{name:e.name}:{},code:e.code,message:e.message,retriable:e.retriable,...void 0!==e.httpStatus?{httpStatus:e.httpStatus}:{}}}}