import{randomUUID}from"node:crypto";import{isPlainRecord as isRecord}from"../utils/json.js";import{MessageQueue}from"../utils/mq.js";import{asNonEmptyTextChunk as asTextChunk,asTrimmedNonEmptyString as asString,normalizeTransportText}from"../utils/text.js";import{resolveUriFileName}from"./prompt-converter.js";import{buildToolResultSessionContentBlocks}from"../tool-result-message-blocks.js";import{resolveToolResultPayloadFromStrategies}from"./tool-result-payload-strategies.js";const MAIN_SESSION_KEY="agent:main:main",CRON_SIGNAL_WINDOW_MS=6e4,CRON_ASSISTANT_FLUSH_TIMEOUT_MS=12e4;export class AcpGatewayEvents{state;logger;sendSessionUpdate;completePrompt;failPrompt;replayMissingPromptArtifactsFromLocalHistory;cronRunIds=new Set;cronRequestIdsByKey=new Map;cronAssistantTsByKey=new Map;cronAssistantTextByKey=new Map;cronAssistantPayloadByKey=new Map;cronAssistantFlushTimersByKey=new Map;cronAssistantFlushTimeoutMs;lastMainCronSignalAtMs=0;currentAssistantStream=null;getCurrentAssistantStream(){return this.currentAssistantStream}constructor(t){this.state=t.state,this.logger=t.logger,this.sendSessionUpdate=t.sendSessionUpdate,this.completePrompt=t.completePrompt,this.failPrompt=t.failPrompt,this.replayMissingPromptArtifactsFromLocalHistory=t.replayMissingPromptArtifactsFromLocalHistory,this.cronAssistantFlushTimeoutMs="number"==typeof t.cronAssistantFlushTimeoutMs&&Number.isFinite(t.cronAssistantFlushTimeoutMs)&&t.cronAssistantFlushTimeoutMs>0?t.cronAssistantFlushTimeoutMs:12e4}handleGatewayResponse(t){const e=this.state.promptsByGatewayRequestId.get(t.id);if(e&&!e.done){if(!t.ok){const s=isRecord(t.error)&&asString(t.error.message)?asString(t.error.message):"gateway returned error";return void this.failPrompt(e,-32020,s??"gateway returned error",t.error)}if(isRecord(t.payload)){const s=asString(t.payload.runId);s?(this.state.bindPromptRunToRunId(e,s),this.logger.debug?.(`[acp] gateway.response bound runId=${s} requestId=${String(e.gatewayRequestId)} sessionId=${e.sessionId}`)):this.logger.debug?.(`[acp] gateway.response no runId in payload requestId=${String(e.gatewayRequestId)} sessionId=${e.sessionId}`)}}}handleGatewayCronEvent(t){if(!isRecord(t))return;const e=isRecord(t.payload)?t.payload:t,s=this.resolveSessionKey(e)??this.resolveSessionKey(t);if(s&&s!==MAIN_SESSION_KEY)return;this.lastMainCronSignalAtMs=Date.now();const n=asString(e.runId)??asString(e.run_id)??asString(t.runId)??asString(t.run_id);n&&this.cronRunIds.add(n)}async handleGatewayAgentEvent(t){if(!isRecord(t))return;const e=asString(t.stream),s=isRecord(t.data)?t.data:{},n=asString(t.runId),o=asString(t.requestId)??asString(t.request_id),a=asString(s.name)??asString(s.toolName)??asString(s.tool_name)??"tool",i=asString(s.toolCallId)??asString(s.tool_call_id)??asString(s.callId)??asString(s.id),r=this.state.resolvePromptRun(t);if(!r||r.done)return this.logger.debug?.(`[acp][uncorrelated-agent] stream=${e||"unknown"} runId=${n||"n/a"} requestId=${o||"n/a"} tool=${a} toolCallId=${i||"n/a"}`),void this.handleUncorrelatedMainCronAssistantEvent(t);this.logger.debug?.(`[acp][agent-event] stream=${e||"unknown"} runId=${n||"n/a"} requestId=${o||"n/a"} tool=${a} toolCallId=${i||"n/a"} sessionId=${r.sessionId}`);const l={before:{type:"event",event:"agent",payload:t},hop:"openclaw_gateway->plugin",where:"AcpGatewayBridge.handleGatewayAgentEvent"},d=this.resolvePayloadTimestamp(t),c=this.withTimestamp(r.rpcId,d),u=t=>{if(this.sendSessionUpdate(r.sessionId,t,c,l),this.currentAssistantStream){const e={data:t};void 0!==d&&(e.ts=d),this.currentAssistantStream.push(e)}},g=()=>{u({sessionUpdate:"agent_message_chunk",content:{type:"text",text:"\n"}})};if("assistant"===e){r.hasAgentAssistantStream=!0;const t=asTextChunk(s.delta)??asTextChunk(s.text);t&&u({sessionUpdate:"agent_message_chunk",content:{type:"text",text:t}});const e=[];Array.isArray(s.content)?e.push(...s.content):isRecord(s.content)?e.push(s.content):"string"==typeof s.type&&e.push(s);for(const s of e){if(!isRecord(s))continue;const e=asString(s.type);if("thinking"===e){r.hasAgentThinkingStream=!0;const t=this.normalizeText(s.thinking)??this.normalizeText(s.text);if(!t)continue;u({sessionUpdate:"agent_thought_chunk",content:{type:"text",text:t}});continue}if("toolCall"===e){g(),r.hasAgentToolStartStream=!0;const t=this.resolveToolCallId(r,s,"start"),e=asString(s.name)??asString(s.toolName)??asString(s.tool_name)??"tool",n=isRecord(s.arguments)?s.arguments:isRecord(s.args)?s.args:{};u({sessionUpdate:"tool_call",toolCallId:t,title:e,status:"in_progress",content:[{type:"content",content:{type:"text",text:JSON.stringify(n,null,2)}}]});continue}if("toolResult"===e){g(),r.hasAgentToolResultStream=!0;const t=this.resolveToolCallId(r,s,"result"),e=asString(s.name)??asString(s.toolName)??asString(s.tool_name)??"tool",n=buildToolResultSessionContentBlocks(e,s);if(n.length>0){u({sessionUpdate:"tool_call_update",toolCallId:t,title:e,status:"completed",content:n});continue}const o=this.normalizeText(s.text)??this.normalizeText(s.result)??(isRecord(s.result)||Array.isArray(s.result)?JSON.stringify(s.result,null,2):void 0);if(!o)continue;u({sessionUpdate:"tool_call_update",toolCallId:t,title:e,status:"completed",content:[{type:"content",content:{type:"text",text:o}}]});continue}const n=this.toSessionMessageContentBlock(s);n&&("text"===asString(n.type)&&t||u({sessionUpdate:"agent_message_chunk",content:n}))}return}if("thinking"===e){r.hasAgentThinkingStream=!0;const t=asTextChunk(s.delta)??asTextChunk(s.text);return void(t&&u({sessionUpdate:"agent_thought_chunk",content:{type:"text",text:t}}))}if("tool"===e){const t=asString(s.phase),e=this.resolveToolCallId(r,s,t),a=asString(s.name)||asString(s.toolName)||asString(s.tool_name)||"tool",i=Object.keys(s).sort().join(",");if("start"===t){const t=isRecord(s.arguments)?s.arguments:isRecord(s.args)?s.args:{};this.logger.debug?.(`[acp][tool][start] runId=${n||"n/a"} requestId=${o||"n/a"} tool=${a} toolCallId=${e} sessionId=${r.sessionId} payloadKeys=${i} hasArgs=${isRecord(t)}`),g(),r.hasAgentToolStartStream=!0,u({sessionUpdate:"tool_call",toolCallId:e,title:a,status:"in_progress",content:[{type:"content",content:{type:"text",text:JSON.stringify(t,null,2)}}]})}else if("result"===t){const t=await resolveToolResultPayloadFromStrategies(a,s,{toolCallId:e}),l=t.delivery??"tool_call_update";this.logger.debug?.(`[acp][tool][result-resolved] runId=${n||"n/a"} requestId=${o||"n/a"} tool=${a} toolCallId=${e} source=${t.source} payloadKeys=${i} sessionId=${r.sessionId}`);const d=t.payload??s,c=s;if("agent_message_chunk"===l){const t=buildToolResultSessionContentBlocks(a,d);if(t.length>0){g(),r.hasAgentToolResultStream=!0;let s=!1;for(const e of t){if(!isRecord(e))continue;const t=isRecord(e.content)?e.content:void 0,n=t?this.toSessionMessageContentBlock(t):void 0;n&&(s=!0,u({sessionUpdate:"agent_message_chunk",content:n}))}s&&this.logger.debug?.(`[acp][tool][result-extra-dispatched] runId=${n||"n/a"} requestId=${o||"n/a"} tool=${a} toolCallId=${e} blockCount=${t.length} sessionId=${r.sessionId}`)}else this.logger.debug?.(`[acp][tool][result-empty-no-extra-message] runId=${n||"n/a"} requestId=${o||"n/a"} tool=${a} toolCallId=${e} sessionId=${r.sessionId}`)}const p=c.result??c.output??c,h=void 0!==c.result||void 0!==c.output,y=void 0!==c.details,m=void 0!==c.content,S=Array.isArray(p)?"array":null===p?"null":typeof p,f=isRecord(p)?Object.keys(p).sort().join(","):"";this.logger.debug?.(`[acp][tool][result-received] runId=${n||"n/a"} requestId=${o||"n/a"} tool=${a} toolCallId=${e} sessionId=${r.sessionId} payloadKeys=${i} resultShape=${S} hasResultOrOutput=${h} hasDetails=${y} hasContent=${m} recordKeys=${f}`),g(),r.hasAgentToolResultStream=!0;const I=buildToolResultSessionContentBlocks(a,c);if(I.length>0)return this.logger.debug?.(`[acp][tool][result-dispatched] runId=${n||"n/a"} requestId=${o||"n/a"} tool=${a} toolCallId=${e} blockCount=${I.length} sessionId=${r.sessionId}`),void u({sessionUpdate:"tool_call_update",toolCallId:e,status:"completed",content:I});const T=this.normalizeText(p)??(isRecord(p)||Array.isArray(p)?JSON.stringify(p,null,2):void 0);if("string"!=typeof T)return void this.logger.debug?.(`[acp][tool][result-drop-no-text] runId=${n||"n/a"} requestId=${o||"n/a"} tool=${a} toolCallId=${e} payloadHasResult=${!!c.result} payloadHasOutput=${!!c.output} payloadHasDetails=${!!c.details} payloadHasContent=${!!c.content} payloadKeys=${i} sessionId=${r.sessionId}`);this.logger.debug?.(`[acp][tool][result-text] runId=${n||"n/a"} requestId=${o||"n/a"} tool=${a} toolCallId=${e} textLen=${T.length} sessionId=${r.sessionId}`),u({sessionUpdate:"tool_call_update",toolCallId:e,status:"completed",content:[{type:"content",content:{type:"text",text:T}}]})}else this.logger.debug?.(`[acp][tool][phase-unknown] runId=${n||"n/a"} requestId=${o||"n/a"} tool=${a} toolCallId=${e} phase=${t||"n/a"} payloadKeys=${i} sessionId=${r.sessionId}`);return}if("lifecycle"===e){const e=asString(s.phase);if("start"===e?this.currentAssistantStream=new MessageQueue:(this.currentAssistantStream?.close(),this.currentAssistantStream=null),"end"===e)this.clearCronStreamTracking(t),this.replayMissingPromptArtifactsFromLocalHistory(r),this.completePrompt(r,"end_turn");else if("cancelled"===e||"cancel"===e)this.clearCronStreamTracking(t),this.completePrompt(r,"cancelled");else if("error"===e){this.clearCronStreamTracking(t);const e=isRecord(s.error)&&asString(s.error.message)?asString(s.error.message):void 0,n=asString(s.message)??e??"gateway lifecycle error";this.failPrompt(r,-32021,n,s)}}}handleGatewayChatEvent(t){if(!isRecord(t))return;const e=this.state.resolvePromptRun(t);if(!e||e.done)return void this.handleUncorrelatedMainCronChatEvent(t);const s={before:{type:"event",event:"chat",payload:t},hop:"openclaw_gateway->plugin",where:"AcpGatewayBridge.handleGatewayChatEvent"},n=this.resolvePayloadTimestamp(t),o=this.withTimestamp(e.rpcId,n),a=()=>{this.maybeCompletePromptFromChatState(e,t)},i=isRecord(t.message)?t.message:void 0;if(!i)return void a();const r=asString(i.role);if(r){if("assistant"===r){const n=[];Array.isArray(i.content)?n.push(...i.content):"string"==typeof i.content?n.push({type:"text",text:i.content}):isRecord(i.content)&&n.push(i.content);for(const a of n){if(!isRecord(a))continue;const n=asString(a.type);if(!n)continue;if("thinking"===n){if(e.hasAgentThinkingStream)continue;const t=this.normalizeText(a.thinking)??this.normalizeText(a.text);if(!t)continue;const n=`chat:thinking:${t}`;if(e.chatReplayDedupKeys.has(n))continue;e.chatReplayDedupKeys.add(n),this.sendSessionUpdate(e.sessionId,{sessionUpdate:"agent_thought_chunk",content:{type:"text",text:t}},o,s);continue}if("toolCall"===n){if(this.sendToolCallSpacer(e.sessionId,o,{before:{type:"event",event:"chat",payload:t},hop:"openclaw_gateway->plugin",where:"AcpGatewayBridge.handleGatewayChatEvent"}),e.hasAgentToolStartStream)continue;const n=this.resolveToolCallId(e,a,"start"),i=asString(a.name)??asString(a.toolName)??asString(a.tool_name)??"tool",r=isRecord(a.arguments)?a.arguments:isRecord(a.args)?a.args:{},l=`chat:tool_start:${n}:${JSON.stringify(r)}`;if(e.chatReplayDedupKeys.has(l))continue;e.chatReplayDedupKeys.add(l),this.sendSessionUpdate(e.sessionId,{sessionUpdate:"tool_call",toolCallId:n,title:i,status:"in_progress",content:[{type:"content",content:{type:"text",text:JSON.stringify(r,null,2)}}]},o,s);continue}if("toolResult"===n){if(this.sendToolCallSpacer(e.sessionId,o,{before:{type:"event",event:"chat",payload:t},hop:"openclaw_gateway->plugin",where:"AcpGatewayBridge.handleGatewayChatEvent"}),e.hasAgentToolResultStream)continue;const n=this.resolveToolCallId(e,a,"result"),i=asString(a.name)??asString(a.toolName)??asString(a.tool_name)??"tool",r=buildToolResultSessionContentBlocks(i,a);if(r.length>0){const t=`chat:tool_result:${n}:${JSON.stringify(r)}`;if(e.chatReplayDedupKeys.has(t))continue;e.chatReplayDedupKeys.add(t),this.sendSessionUpdate(e.sessionId,{sessionUpdate:"tool_call_update",toolCallId:n,title:i,status:"completed",content:r},o,s);continue}const l=this.normalizeText(a.text)??this.normalizeText(a.result)??(isRecord(a.result)||Array.isArray(a.result)?JSON.stringify(a.result,null,2):void 0);if(!l)continue;const d=`chat:tool_result:${n}:${l}`;if(e.chatReplayDedupKeys.has(d))continue;e.chatReplayDedupKeys.add(d),this.sendSessionUpdate(e.sessionId,{sessionUpdate:"tool_call_update",toolCallId:n,title:i,status:"completed",content:[{type:"content",content:{type:"text",text:l}}]},o,s);continue}const i=this.toSessionMessageContentBlock(a);if(!i)continue;if("text"===asString(i.type)){if(e.hasAgentAssistantStream)continue;const t=asString(i.text),n=this.toChatAssistantDeltaText(e,t);if(!n)continue;this.sendSessionUpdate(e.sessionId,{sessionUpdate:"agent_message_chunk",content:{type:"text",text:n}},o,s);continue}const r=`chat:assistant_chunk:${JSON.stringify(i)}`;e.chatReplayDedupKeys.has(r)||(e.chatReplayDedupKeys.add(r),this.sendSessionUpdate(e.sessionId,{sessionUpdate:"agent_message_chunk",content:i},o,s))}return void a()}if("toolResult"===r){if(e.hasAgentToolResultStream)return void a();const t=asString(i.toolCallId)??asString(i.tool_call_id);if(!t)return void a();const n=asString(i.toolName)??asString(i.tool_name)??"tool",r=this.extractMessageText({content:i.content});if(!r)return void a();const l=`chat:tool_result:${t}:${r}`;if(e.chatReplayDedupKeys.has(l))return void a();e.chatReplayDedupKeys.add(l),this.sendSessionUpdate(e.sessionId,{sessionUpdate:"tool_call_update",toolCallId:t,title:n,status:"completed",content:[{type:"content",content:{type:"text",text:r}}]},o,s)}a()}else a()}maybeCompletePromptFromChatState(t,e){if(t.done||"chat.send"!==t.gatewayMethod)return;const s=asString(e.state)?.toLowerCase();if(s)if("final"!==s)if("aborted"!==s&&"cancelled"!==s&&"cancel"!==s){if("error"===s){const s=isRecord(e.error)?e.error:void 0,n=asString(e.summary)??asString(e.message)??asString(s?.message)??"gateway chat error";this.failPrompt(t,-32021,n,e)}}else this.completePrompt(t,"cancelled");else this.completePrompt(t,"end_turn")}handleUncorrelatedMainCronChatEvent(t){if(this.resolveSessionKey(t)!==MAIN_SESSION_KEY)return;if(!this.isCronAssistantCandidate(t))return;const e=isRecord(t.message)?t.message:void 0;if(!e)return;if("user"!==asString(e.role))return;const s="user_message_chunk",n={before:{type:"event",event:"chat",payload:t},hop:"openclaw_gateway->plugin",where:"AcpGatewayBridge.handleGatewayChatEvent.cron"},o=this.resolveCronSessionUpdateMeta(t),a=e.content,i=[];Array.isArray(a)?i.push(...a):isRecord(a)&&i.push(a);let r=!1;for(const t of i){if(!isRecord(t))continue;const e=this.toSessionMessageContentBlock(t);e&&(this.sendSessionUpdate(MAIN_SESSION_KEY,{sessionUpdate:s,content:e},o,n),r=!0)}if(r)return;const l=this.extractMessageText({content:a});l&&this.sendSessionUpdate(MAIN_SESSION_KEY,{sessionUpdate:s,content:{type:"text",text:l}},o,n)}handleUncorrelatedMainCronAssistantEvent(t){const e=asString(t.stream);if("lifecycle"===e){const e=isRecord(t.data)?t.data:{},s=asString(e.phase);return void("end"===s?(this.flushCronAssistantText(t),this.clearCronStreamTracking(t)):"cancelled"!==s&&"cancel"!==s&&"error"!==s||this.clearCronStreamTracking(t))}if("assistant"!==e)return void(e&&this.logger.debug?.(`[acp][uncorrelated-agent] stream=${e} runId=${asString(t.runId)||asString(t.run_id)||"n/a"} requestId=${asString(t.requestId)||asString(t.request_id)||"n/a"} sessionKey=${this.resolveSessionKey(t)||"n/a"}`));if(this.resolveSessionKey(t)!==MAIN_SESSION_KEY)return;if(!this.isCronAssistantCandidate(t))return;const s={before:{type:"event",event:"agent",payload:t},hop:"openclaw_gateway->plugin",where:"AcpGatewayBridge.handleGatewayAgentEvent.cron"},n=this.resolveCronSessionUpdateMeta(t),o=isRecord(t.data)?t.data:{},a=asTextChunk(o.delta)??asTextChunk(o.text);a&&this.bufferCronAssistantText(t,a,n,s);const i=[];Array.isArray(o.content)?i.push(...o.content):isRecord(o.content)?i.push(o.content):"string"==typeof o.type&&i.push(o);for(const e of i){if(!isRecord(e))continue;const o=asString(e.type);if("thinking"===o||"toolCall"===o||"toolResult"===o)continue;const i=this.toSessionMessageContentBlock(e);if(i){if("text"===asString(i.type)){if(a)continue;const e=asString(i.text);e&&this.bufferCronAssistantText(t,e,n,s);continue}this.sendSessionUpdate(MAIN_SESSION_KEY,{sessionUpdate:"agent_message_chunk",content:i},n,s)}}}sendToolCallSpacer(t,e,s){this.sendSessionUpdate(t,{sessionUpdate:"agent_message_chunk",content:{type:"text",text:"\n"}},e,s)}isCronAssistantCandidate(t){const e=asString(t.runId)??asString(t.run_id);return!(!e||!this.cronRunIds.has(e))||!(Date.now()-this.lastMainCronSignalAtMs>6e4)&&(e&&this.cronRunIds.add(e),!0)}resolveSessionKey(t){const e=asString(t.sessionKey)??asString(t.session_key);if(e)return e;const s=isRecord(t.payload)?t.payload:void 0;if(s){const t=asString(s.sessionKey)??asString(s.session_key);if(t)return t}const n=isRecord(t.data)?t.data:void 0;if(n){const t=asString(n.sessionKey)??asString(n.session_key);if(t)return t}}resolveCronSessionUpdateMeta(t){const e=this.resolveCronStreamKey(t),s=this.resolveCronSessionUpdateMetaByKey(e),n=this.resolvePayloadTimestamp(t);return void 0===n?s:(e&&this.cronAssistantTsByKey.set(e,n),void 0!==s.timestamp?s:{...s,timestamp:n})}resolveCronSessionUpdateMetaByKey(t){if(!t)return{requestId:randomUUID(),messageType:"cron"};const e=this.cronRequestIdsByKey.get(t);if(e){const s=this.cronAssistantTsByKey.get(t);return void 0===s?{requestId:e,messageType:"cron"}:{requestId:e,messageType:"cron",timestamp:s}}const s=randomUUID();this.cronRequestIdsByKey.set(t,s);const n=this.cronAssistantTsByKey.get(t);return void 0===n?{requestId:s,messageType:"cron"}:{requestId:s,messageType:"cron",timestamp:n}}resolveCronStreamKey(t){const e=asString(t.runId)??asString(t.run_id);if(e)return`run:${e}`;const s=asString(t.requestId)??asString(t.request_id);return s?`request:${s}`:void 0}clearCronStreamTracking(t){const e=asString(t.runId)??asString(t.run_id);e&&this.clearCronStreamTrackingByKey(`run:${e}`);const s=asString(t.requestId)??asString(t.request_id);s&&this.clearCronStreamTrackingByKey(`request:${s}`)}clearCronStreamTrackingByKey(t){this.cronRequestIdsByKey.delete(t),this.cronAssistantTsByKey.delete(t),this.cronAssistantTextByKey.delete(t),this.cronAssistantPayloadByKey.delete(t);const e=this.cronAssistantFlushTimersByKey.get(t);if(e&&(clearTimeout(e),this.cronAssistantFlushTimersByKey.delete(t)),t.startsWith("run:")){const e=t.slice(4);e&&this.cronRunIds.delete(e)}}bufferCronAssistantText(t,e,s,n){const o=this.normalizeText(e);if(!o)return;const a=this.resolveCronStreamKey(t);if(!a)return void this.sendSessionUpdate(MAIN_SESSION_KEY,{sessionUpdate:"agent_message_chunk",content:{type:"text",text:o}},s,n);const i=this.cronAssistantTextByKey.get(a)??"";this.cronAssistantTextByKey.set(a,`${i}${o}`),this.cronAssistantPayloadByKey.set(a,t),this.scheduleCronAssistantFlush(a)}flushCronAssistantText(t){const e=this.resolveCronStreamKey(t);e&&this.flushCronAssistantTextByKey(e,"end",t)}scheduleCronAssistantFlush(t){const e=this.cronAssistantFlushTimersByKey.get(t);e&&clearTimeout(e);const s=setTimeout(()=>{this.cronAssistantFlushTimersByKey.delete(t),this.flushCronAssistantTextByKey(t,"timeout")},this.cronAssistantFlushTimeoutMs);this.cronAssistantFlushTimersByKey.set(t,s)}flushCronAssistantTextByKey(t,e,s){const n=this.cronAssistantFlushTimersByKey.get(t);n&&(clearTimeout(n),this.cronAssistantFlushTimersByKey.delete(t));const o=this.cronAssistantTextByKey.get(t);if(!o)return void("timeout"===e&&this.clearCronStreamTrackingByKey(t));this.cronAssistantTextByKey.delete(t);const a=s??this.cronAssistantPayloadByKey.get(t);this.cronAssistantPayloadByKey.delete(t);const i=this.normalizeText(o);if(!i)return void("timeout"===e&&this.clearCronStreamTrackingByKey(t));const r=this.resolveCronSessionUpdateMetaByKey(t),l="timeout"===e?"timeout":"end";this.sendSessionUpdate(MAIN_SESSION_KEY,{sessionUpdate:"agent_message_chunk",content:{type:"text",text:i}},r,{before:a?{type:"event",event:"agent",payload:a}:{type:"event",event:"cron",payload:{key:t,reason:e}},hop:"openclaw_gateway->plugin",where:`AcpGatewayBridge.handleGatewayAgentEvent.cron.flush.${l}`}),"timeout"===e&&this.clearCronStreamTrackingByKey(t)}extractMessageText(t){const e=t.content;if("string"==typeof e)return this.normalizeText(e);if(Array.isArray(e)){const t=[];for(const s of e)if(isRecord(s)){const e=this.normalizeText(s.text);e&&t.push(e)}if(!t.length)return;return this.normalizeText(t.join("\n"))}}resolvePayloadTimestamp(t){const e=this.resolveTimestampValue(t.ts);if(void 0!==e)return e;const s=this.resolveTimestampValue(t.timestamp);if(void 0!==s)return s;const n=isRecord(t.payload)?t.payload:void 0;if(n){const t=this.resolvePayloadTimestamp(n);if(void 0!==t)return t}const o=isRecord(t.data)?t.data:void 0;if(o){const t=this.resolvePayloadTimestamp(o);if(void 0!==t)return t}const a=isRecord(t.message)?t.message:void 0;if(a){const t=this.resolvePayloadTimestamp(a);if(void 0!==t)return t}}withTimestamp(t,e){return void 0===e?t:"string"==typeof t||"number"==typeof t?{requestId:t,messageType:"normal",timestamp:e}:void 0!==t.timestamp?t:{...t,timestamp:e}}resolveTimestampValue(t){if("number"==typeof t&&Number.isFinite(t))return t;if("string"==typeof t){const e=Date.parse(t);if(Number.isFinite(e))return e}}normalizeText(t){return normalizeTransportText(t)}toChatAssistantDeltaText(t,e){const s=this.normalizeText(e);if(!s)return;const n=t.chatAssistantTextSoFar;if(!n)return t.chatAssistantTextSoFar=s,s;if(s!==n){if(s.startsWith(n)){const e=s.slice(n.length);return t.chatAssistantTextSoFar=s,e||void 0}if(!n.startsWith(s))return t.chatAssistantTextSoFar=s,s}}toSessionMessageContentBlock(t){const e=asString(t.type);if(e){if("text"===e){const e=this.normalizeText(t.text);if(!e)return;return{type:"text",text:e}}if("image"===e){const e=asString(t.data),s=asString(t.uri);if(!e&&!s)return;const n=asString(t.mimeType)??asString(t.mime_type),o=asString(t.fileName)??asString(t.file_name)??asString(t.filename)??asString(t.name)??(s?resolveUriFileName(s):void 0);return{type:"image",...e?{data:e}:{},...s?{uri:s}:{},...n?{mimeType:n}:{},...o?{fileName:o}:{}}}if("resource_link"===e){const e=asString(t.uri);if(!e)return;const s=asString(t.title),n=asString(t.name),o=asString(t.mimeType)??asString(t.mime_type);return{type:"resource_link",uri:e,...s?{title:s}:{},...n?{name:n}:{},...o?{mimeType:o}:{}}}if("resource"===e){const e=isRecord(t.resource)?t.resource:{},s=asString(e.uri)??asString(t.uri),n=asString(e.mimeType)??asString(e.mime_type)??asString(t.mimeType)??asString(t.mime_type),o=this.normalizeText(e.text)??this.normalizeText(t.text),a=asString(e.data)??asString(t.data),i=asString(e.fileName)??asString(e.file_name)??asString(e.filename)??asString(e.name)??asString(t.fileName)??asString(t.file_name)??asString(t.filename)??asString(t.name)??(s?resolveUriFileName(s):void 0);if(!s&&!o&&!a)return;return{type:"resource",resource:{...s?{uri:s}:{},...n?{mimeType:n}:{},...o?{text:o}:{},...a?{data:a}:{},...i?{fileName:i}:{}}}}if("file"===e){const e=asString(t.data),s=this.normalizeText(t.text),n=asString(t.uri),o=asString(t.mimeType)??asString(t.mime_type),a=asString(t.fileName)??asString(t.file_name)??asString(t.filename)??asString(t.name)??(n?resolveUriFileName(n):void 0);if(!e&&!s&&!n)return;return{type:"file",...e?{data:e}:{},...s?{text:s}:{},...n?{uri:n}:{},...o?{mimeType:o}:{},...a?{fileName:a}:{}}}}}resolveToolCallId(t,e,s){const n=asString(e.toolCallId)||asString(e.tool_call_id)||asString(e.callId)||asString(e.id);if(n){return t.toolCallIdsByIncomingId.get(n)||(t.toolCallIdsByIncomingId.set(n,n),n)}if("result"===s){const e=t.pendingGeneratedToolCallIds.shift();if(e)return e}t.nextGeneratedToolCallId+=1;const o=`tc_${t.gatewayRequestId}_${t.nextGeneratedToolCallId}`;return"start"===s&&t.pendingGeneratedToolCallIds.push(o),o}}