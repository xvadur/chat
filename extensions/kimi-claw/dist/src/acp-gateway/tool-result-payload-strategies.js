import{isPlainRecord as isRecord}from"../utils/json.js";import{KIMI_UPLOAD_TOOL_NAME}from"../kimi-upload-tool.js";import{cleanupKimiUploadToolResultCache,readKimiUploadToolResult}from"../kimi-upload-tool-result-cache.js";const toRecordShape=o=>isRecord(o)?o:void 0,kimiUploadToolResultPayloadStrategy={name:"kimi_upload_file_cache",canHandle:o=>o===KIMI_UPLOAD_TOOL_NAME,resolve:async(o,a,e)=>{const l=e.toolCallId;try{if(!l)return{handled:!0,source:"cache-missing-toolCallId"};const o=await readKimiUploadToolResult(l),a=toRecordShape(o);return a?{handled:!0,payload:a,source:"cache",delivery:"tool_call_update"}:{handled:!0,source:"cache-miss"}}finally{cleanupKimiUploadToolResultCache()}}},passthroughToolResultPayloadStrategy={name:"passthrough_gateway_result",canHandle:()=>!0,resolve:async(o,a)=>({handled:!0,payload:a,source:"gateway-payload",delivery:"tool_call_update"})};let toolResultPayloadStrategies=[kimiUploadToolResultPayloadStrategy,passthroughToolResultPayloadStrategy];export const registerToolResultPayloadStrategy=(o,a)=>{a?.prepend?toolResultPayloadStrategies.unshift(o):toolResultPayloadStrategies.push(o)};export const setToolResultPayloadStrategies=o=>{toolResultPayloadStrategies=[...o]};export const getToolResultPayloadStrategies=()=>[...toolResultPayloadStrategies];export const resetToolResultPayloadStrategies=()=>{toolResultPayloadStrategies=[kimiUploadToolResultPayloadStrategy,passthroughToolResultPayloadStrategy]};export const resolveToolResultPayloadFromStrategies=async(o,a,e)=>{const l=toRecordShape(a)??{};for(const a of toolResultPayloadStrategies){if(!a.canHandle(o,l,e))continue;const t=await a.resolve(o,l,e);if(t.handled)return t}return{handled:!0,payload:l,source:"fallback-gateway-payload",delivery:"tool_call_update"}};