import{randomUUID}from"node:crypto";import{isPlainRecord as isRecord}from"../utils/json.js";import{asTrimmedNonEmptyString as asString,normalizeTransportText}from"../utils/text.js";import{resolveUriFileName}from"./prompt-converter.js";import{buildToolResultSessionContentBlocks}from"../tool-result-message-blocks.js";export class AcpGatewayHistoryReplay{logger;state;isGatewayReady;sendGatewayFrame;sendSessionUpdate;readLocalHistoryMessages;readLocalHistoryEntries;historyPendingTimeoutMs;constructor(t){this.logger=t.logger,this.state=t.state,this.isGatewayReady=t.isGatewayReady,this.sendGatewayFrame=t.sendGatewayFrame,this.sendSessionUpdate=t.sendSessionUpdate,this.readLocalHistoryMessages=t.readLocalHistoryMessages,this.readLocalHistoryEntries=t.readLocalHistoryEntries,this.historyPendingTimeoutMs=t.historyPendingTimeoutMs}fetchHistory(t,e,s){if(!this.isGatewayReady())return this.logger.warn("[acp] skipping history fetch â€“ gateway not ready"),void e?.();const o=`hist_${randomUUID().replace(/-/g,"")}`,n={type:"req",id:o,method:"chat.history",params:{sessionKey:t,limit:100}};if(this.sendGatewayFrame(n)){const n={sessionId:t,onComplete:e,requestId:s};return this.historyPendingTimeoutMs>0&&(n.timeoutTimer=setTimeout(()=>{const e=this.state.takePendingHistoryRequest(o);e&&(this.logger.warn(`[acp] history request timed out requestId=${o} sessionId=${t} timeoutMs=${this.historyPendingTimeoutMs}`),e.onComplete?.())},this.historyPendingTimeoutMs),n.timeoutTimer.unref?.()),this.state.setPendingHistoryRequest(o,n),void this.logger.info(`[acp] history request sent requestId=${o} sessionId=${t} sessionKey=${t}`)}this.logger.warn("[acp] failed to send history request to gateway"),e?.()}handleHistoryResponse(t){if(!this.state.hasPendingHistoryRequest(t.id))return!1;const e=this.state.takePendingHistoryRequest(t.id);if(!e)return!0;const s=e.sessionId,o=e.requestId;if(!t.ok){const s=isRecord(t.error)&&asString(t.error.message)?t.error.message:"unknown";return this.logger.warn(`[acp] history fetch failed requestId=${t.id} error=${s}`),e.onComplete?.(),!0}const n=isRecord(t.payload)?t.payload:{};let i=Array.isArray(n.messages)?n.messages:[];if(0===i.length){const t=asString(n.sessionId)??s,e=asString(n.sessionKey)??s;let o=this.readLocalHistoryEntries(t,e);0===o.length&&(o=this.readLocalHistoryMessages(t,e)),o.length>0&&(i=o,this.logger.info(`[acp] history fallback from local session files sessionId=${t} sessionKey=${e} count=${i.length}`))}this.logger.info(`[acp] history loaded requestId=${t.id} count=${i.length}`);for(const t of i)isRecord(t)&&this.replayHistoryMessage(s,t,o);return e.onComplete?.(),!0}replaySessionLoad(t,e){const s=this.readLocalHistoryEntries(t,t);for(const o of s)this.replayHistoryMessage(t,o,e);return s.length}replayMissingPromptArtifactsFromLocalHistory(t){const e=this.readLocalHistoryEntries(t.sessionId,t.sessionId);if(!e.length)return;const s=t.startedAt-2e3,o=e.filter(t=>"number"==typeof t.timestamp&&Number.isFinite(t.timestamp)&&t.timestamp>=s);if(o.length)for(const e of o){const s=this.resolveSessionUpdateMeta(t.rpcId,e.timestamp);if("assistant"===e.role){const o=[];Array.isArray(e.content)?o.push(...e.content):"string"==typeof e.content?o.push({type:"text",text:e.content}):isRecord(e.content)&&o.push(e.content);let n=!1;for(const e of o){if(!isRecord(e))continue;const o=asString(e.type);if("thinking"===o){const o=this.normalizeText(e.thinking)??this.normalizeText(e.text);if(!o)continue;const i=`local:thinking:${o}`;if(t.chatReplayDedupKeys.has(i))continue;t.chatReplayDedupKeys.add(i),t.hasAgentThinkingStream=!0,this.sendSessionUpdate(t.sessionId,{sessionUpdate:"agent_thought_chunk",content:{type:"text",text:o}},s),n=!0;continue}if("toolCall"===o){const o=this.resolveToolCallId(t,e,"start"),i=asString(e.name)??asString(e.toolName)??asString(e.tool_name)??"tool",a=isRecord(e.arguments)?e.arguments:isRecord(e.args)?e.args:{},r=`local:tool_start:${o}:${JSON.stringify(a)}`;if(t.chatReplayDedupKeys.has(r))continue;t.chatReplayDedupKeys.add(r),t.hasAgentToolStartStream=!0,this.sendSessionUpdate(t.sessionId,{sessionUpdate:"tool_call",toolCallId:o,title:i,status:"in_progress",content:[{type:"content",content:{type:"text",text:JSON.stringify(a,null,2)}}]},s),n=!0;continue}if("toolResult"===o){const o=this.resolveToolCallId(t,e,"result"),i=asString(e.name)??asString(e.toolName)??asString(e.tool_name)??"tool",a=buildToolResultSessionContentBlocks(i,e);if(a.length>0){const e=`local:tool_result:${o}:${JSON.stringify(a)}`;if(t.chatReplayDedupKeys.has(e))continue;t.chatReplayDedupKeys.add(e),t.hasAgentToolResultStream=!0,this.sendSessionUpdate(t.sessionId,{sessionUpdate:"tool_call_update",toolCallId:o,title:i,status:"completed",content:a},s),n=!0;continue}const r=this.normalizeText(e.text)??this.normalizeText(e.result)??this.extractMessageText({content:e.content})??(isRecord(e.result)||Array.isArray(e.result)?JSON.stringify(e.result,null,2):void 0);if(!r)continue;const l=`local:tool_result:${o}:${r}`;if(t.chatReplayDedupKeys.has(l))continue;t.chatReplayDedupKeys.add(l),t.hasAgentToolResultStream=!0,this.sendSessionUpdate(t.sessionId,{sessionUpdate:"tool_call_update",toolCallId:o,title:i,status:"completed",content:[{type:"content",content:{type:"text",text:r}}]},s),n=!0;continue}const i=this.toSessionMessageContentBlock(e);if(!i)continue;if("text"===asString(i.type)){if(t.hasAgentAssistantStream)continue;const e=asString(i.text),o=this.toChatAssistantDeltaText(t,e);if(!o)continue;this.sendSessionUpdate(t.sessionId,{sessionUpdate:"agent_message_chunk",content:{type:"text",text:o}},s),n=!0;continue}const a=`local:assistant_chunk:${JSON.stringify(i)}`;t.chatReplayDedupKeys.has(a)||(t.chatReplayDedupKeys.add(a),this.sendSessionUpdate(t.sessionId,{sessionUpdate:"agent_message_chunk",content:i},s),n=!0)}if(!n&&!t.hasAgentAssistantStream){const o=this.extractMessageText({content:e.content,stopReason:e.stopReason,errorMessage:e.errorMessage})??this.extractAssistantErrorText({stopReason:e.stopReason,errorMessage:e.errorMessage}),n=this.toChatAssistantDeltaText(t,o);n&&this.sendSessionUpdate(t.sessionId,{sessionUpdate:"agent_message_chunk",content:{type:"text",text:n}},s)}continue}if("toolResult"===e.role){const o=e.toolCallId;if(!o){this.logger.debug?.(`[acp][history-replay][tool-result] skip_no_toolCallId sessionId=${t.sessionId}`);continue}const n=e.toolName??"tool";this.logger.debug?.(`[acp][history-replay][tool-result] start sessionId=${t.sessionId} toolCallId=${o} toolName=${n}`);const i=buildToolResultSessionContentBlocks(n,e);if(this.logger.debug?.(`[acp][history-replay][tool-result] strategy_blocks sessionId=${t.sessionId} toolCallId=${o} count=${i.length}`),i.length>0){const n=`local:tool_result:${o}:${JSON.stringify(i)}`;if(t.chatReplayDedupKeys.has(n)){this.logger.debug?.(`[acp][history-replay][tool-result] skip_dedup sessionId=${t.sessionId} toolCallId=${o}`);continue}t.chatReplayDedupKeys.add(n),t.hasAgentToolResultStream=!0;let a=!1;for(const e of i){if(!isRecord(e)||!isRecord(e.content))continue;const n=this.toSessionMessageContentBlock(e.content);n?(this.sendSessionUpdate(t.sessionId,{sessionUpdate:"agent_message_chunk",content:n},s),a=!0):this.logger.debug?.(`[acp][history-replay][tool-result] block_unrenderable sessionId=${t.sessionId} toolCallId=${o}`)}if(a){this.sendSessionUpdate(t.sessionId,{sessionUpdate:"tool_call_update",toolCallId:o,title:e.toolName??"tool",status:"completed",content:i},s),this.logger.debug?.(`[acp][history-replay][tool-result] sent_as_agent_and_tool_result sessionId=${t.sessionId} toolCallId=${o} rendered=${a}`);continue}this.logger.debug?.(`[acp][history-replay][tool-result] no_rendered_block sessionId=${t.sessionId} toolCallId=${o}`)}const a=this.extractMessageText({content:e.content});if(!a){this.logger.debug?.(`[acp][history-replay][tool-result] fallback_skip_no_text sessionId=${t.sessionId} toolCallId=${o}`);continue}this.logger.debug?.(`[acp][history-replay][tool-result] fallback_as_text sessionId=${t.sessionId} toolCallId=${o}`);const r=e.toolName??"tool",l=`local:tool_result:${o}:${a}`;if(t.chatReplayDedupKeys.has(l))continue;t.chatReplayDedupKeys.add(l),t.hasAgentToolResultStream=!0,this.sendSessionUpdate(t.sessionId,{sessionUpdate:"tool_call_update",toolCallId:o,title:r,status:"completed",content:[{type:"content",content:{type:"text",text:a}}]},s)}}}extractMessageText(t){const e=t.content;if("string"==typeof e)return this.normalizeText(e);if(Array.isArray(e)){const t=[];for(const s of e)if(isRecord(s)){const e=this.normalizeText(s.text);e&&t.push(e)}if(!t.length)return;return this.normalizeText(t.join("\n"))}}extractAssistantErrorText(t){const e=this.normalizeText(t.errorMessage)??this.normalizeText(t.error_message)??(isRecord(t.error)?this.normalizeText(t.error.message):void 0);return e||("error"===(asString(t.stopReason)??asString(t.stop_reason))?"Request failed (stopReason=error)":void 0)}normalizeText(t){return normalizeTransportText(t)}toChatAssistantDeltaText(t,e){const s=this.normalizeText(e);if(!s)return;const o=t.chatAssistantTextSoFar;if(!o)return t.chatAssistantTextSoFar=s,s;if(s!==o){if(s.startsWith(o)){const e=s.slice(o.length);return t.chatAssistantTextSoFar=s,e||void 0}if(!o.startsWith(s))return t.chatAssistantTextSoFar=s,s}}toSessionMessageContentBlock(t){const e=asString(t.type);if(e){if("text"===e){const e=this.normalizeText(t.text);if(!e)return;return{type:"text",text:e}}if("image"===e){const e=asString(t.data),s=asString(t.uri);if(!e&&!s)return;const o=asString(t.mimeType)??asString(t.mime_type),n=asString(t.fileName)??asString(t.file_name)??asString(t.filename)??asString(t.name)??(s?resolveUriFileName(s):void 0);return{type:"image",...e?{data:e}:{},...s?{uri:s}:{},...o?{mimeType:o}:{},...n?{fileName:n}:{}}}if("resource_link"===e){const e=asString(t.uri);if(!e)return;const s=asString(t.title),o=asString(t.name),n=asString(t.mimeType)??asString(t.mime_type);return{type:"resource_link",uri:e,...s?{title:s}:{},...o?{name:o}:{},...n?{mimeType:n}:{}}}if("resource"===e){const e=isRecord(t.resource)?t.resource:{},s=asString(e.uri)??asString(t.uri),o=asString(e.mimeType)??asString(e.mime_type)??asString(t.mimeType)??asString(t.mime_type),n=this.normalizeText(e.text)??this.normalizeText(t.text),i=asString(e.data)??asString(t.data),a=asString(e.fileName)??asString(e.file_name)??asString(e.filename)??asString(e.name)??asString(t.fileName)??asString(t.file_name)??asString(t.filename)??asString(t.name)??(s?resolveUriFileName(s):void 0);if(!s&&!n&&!i)return;return{type:"resource",resource:{...s?{uri:s}:{},...o?{mimeType:o}:{},...n?{text:n}:{},...i?{data:i}:{},...a?{fileName:a}:{}}}}if("file"===e){const e=asString(t.data),s=this.normalizeText(t.text),o=asString(t.uri),n=asString(t.mimeType)??asString(t.mime_type),i=asString(t.fileName)??asString(t.file_name)??asString(t.filename)??asString(t.name)??(o?resolveUriFileName(o):void 0);if(!e&&!s&&!o)return;return{type:"file",...e?{data:e}:{},...s?{text:s}:{},...o?{uri:o}:{},...n?{mimeType:n}:{},...i?{fileName:i}:{}}}}}replayHistoryMessage(t,e,s){const o=asString(e.role);if(!o)return;const n=this.resolveSessionUpdateMeta(s,e.timestamp);if("user"===o){const s=e.content;if(Array.isArray(s)){let e=!1;for(const t of s){if(!isRecord(t)||"text"!==asString(t.type))continue;const s=this.normalizeText(t.text);if(s&&s.includes("<KIMI_REF")){e=!0;break}}let o=!1;for(const i of s){if(!isRecord(i))continue;const s=this.toSessionMessageContentBlock(i);if(!s)continue;const a=asString(s.type);if((!e||"image"!==a||!asString(s.data)||asString(s.uri))&&(!e||"file"!==a||!asString(s.data)||asString(s.uri))){if("text"===a){const e=asString(s.text);if(e){const s=this.splitKimiRefReplayText(e);if(s.length>1){o=!0;for(const e of s){const s=this.toBridgeResourceLinkFromKimiRefLine(e)??{type:"text",text:e};this.sendSessionUpdate(t,{sessionUpdate:"user_message_chunk",content:s},n)}continue}}}o=!0,this.sendSessionUpdate(t,{sessionUpdate:"user_message_chunk",content:s},n)}}if(o)return}const o=this.extractMessageText(e);if(!o)return;return void this.sendSessionUpdate(t,{sessionUpdate:"user_message_chunk",content:{type:"text",text:o}},n)}if("assistant"===o){const s=e.content;if(Array.isArray(s)){let o=!1;for(const e of s){if(!isRecord(e))continue;const s=asString(e.type);if("thinking"===s){const s=this.normalizeText(e.thinking)??this.normalizeText(e.text);if(!s)continue;this.sendSessionUpdate(t,{sessionUpdate:"agent_thought_chunk",content:{type:"text",text:s}},n),o=!0;continue}if("toolCall"===s){const s=asString(e.id)??asString(e.toolCallId)??asString(e.tool_call_id)??`tc_hist_${this.state.peekNextMetaIndex()}`,i=asString(e.name)??asString(e.toolName)??asString(e.tool_name)??"tool",a=isRecord(e.arguments)?e.arguments:isRecord(e.args)?e.args:{};this.sendSessionUpdate(t,{sessionUpdate:"tool_call",toolCallId:s,title:i,status:"in_progress",content:[{type:"content",content:{type:"text",text:JSON.stringify(a,null,2)}}]},n),o=!0;continue}if("toolResult"===s){const s=asString(e.id)??asString(e.toolCallId)??asString(e.tool_call_id);if(!s)continue;const i=asString(e.name)??asString(e.toolName)??asString(e.tool_name)??"tool",a=this.normalizeText(e.text)??this.normalizeText(e.result)??this.extractMessageText({content:e.content})??(isRecord(e.result)||Array.isArray(e.result)?JSON.stringify(e.result,null,2):void 0);if(!a)continue;this.sendSessionUpdate(t,{sessionUpdate:"tool_call_update",toolCallId:s,title:i,status:"completed",content:[{type:"content",content:{type:"text",text:a}}]},n),o=!0;continue}const i=this.toSessionMessageContentBlock(e);i&&(this.sendSessionUpdate(t,{sessionUpdate:"agent_message_chunk",content:i},n),o=!0)}if(o)return;const i=this.extractMessageText(e)??this.extractAssistantErrorText(e);if(!i)return;return void this.sendSessionUpdate(t,{sessionUpdate:"agent_message_chunk",content:{type:"text",text:i}},n)}if(isRecord(s)){const e=this.toSessionMessageContentBlock(s);if(e)return void this.sendSessionUpdate(t,{sessionUpdate:"agent_message_chunk",content:e},n)}const o=this.extractMessageText(e)??this.extractAssistantErrorText(e);if(!o)return;return void this.sendSessionUpdate(t,{sessionUpdate:"agent_message_chunk",content:{type:"text",text:o}},n)}if("toolResult"===o){const s=asString(e.toolCallId)??asString(e.tool_call_id);if(!s)return void this.logger.debug?.(`[acp][history-replay][tool-result] skip_no_toolCallId sessionId=${t}`);const o=asString(e.toolName)??asString(e.tool_name)??"tool";this.logger.debug?.(`[acp][history-replay][tool-result] start sessionId=${t} toolCallId=${s} toolName=${o}`);const i=buildToolResultSessionContentBlocks(o,e);if(this.logger.debug?.(`[acp][history-replay][tool-result] strategy_blocks sessionId=${t} toolCallId=${s} count=${i.length}`),i.length>0){let e=!1;for(const o of i){if(!isRecord(o)||!isRecord(o.content))continue;const i=this.toSessionMessageContentBlock(o.content);i?(this.sendSessionUpdate(t,{sessionUpdate:"agent_message_chunk",content:i},n),e=!0):this.logger.debug?.(`[acp][history-replay][tool-result] block_unrenderable sessionId=${t} toolCallId=${s}`)}if(e)return this.sendSessionUpdate(t,{sessionUpdate:"tool_call_update",toolCallId:s,title:o,status:"completed",content:i},n),void this.logger.debug?.(`[acp][history-replay][tool-result] sent_as_agent_and_tool_result sessionId=${t} toolCallId=${s}`);this.logger.debug?.(`[acp][history-replay][tool-result] no_rendered_block sessionId=${t} toolCallId=${s}`)}const a=this.extractMessageText(e);if(!a)return void this.logger.debug?.(`[acp][history-replay][tool-result] fallback_skip_no_text sessionId=${t} toolCallId=${s}`);this.logger.debug?.(`[acp][history-replay][tool-result] fallback_as_text sessionId=${t} toolCallId=${s}`),this.sendSessionUpdate(t,{sessionUpdate:"tool_call_update",toolCallId:s,title:o,status:"completed",content:[{type:"content",content:{type:"text",text:a}}]},n)}}resolveSessionUpdateMeta(t,e){const s=this.resolveTimestamp(e);return void 0===s?t:{requestId:t,messageType:"normal",timestamp:s}}resolveTimestamp(t){if("number"==typeof t&&Number.isFinite(t))return t;if("string"==typeof t){const e=Date.parse(t);if(Number.isFinite(e))return e}}splitKimiRefReplayText(t){if(!t.includes("<KIMI_REF")||!t.includes("\n"))return[t];const e=/^<KIMI_REF\b[^>]*\/>\s*$/,s=t.split("\n"),o=[];let n=[];const i=()=>{if(0===n.length)return;const t=n.join("\n");n=[],t.trim()&&o.push(t)};for(const t of s){const s=t.trim();s.startsWith("<KIMI_REF")&&e.test(s)?(i(),o.push(s)):n.push(t)}return i(),o.length?o:[t]}toBridgeResourceLinkFromKimiRefLine(t){const e=t.trim();if(!e.startsWith("<KIMI_REF"))return;const s=e.match(/\bid\s*=\s*"([^"]+)"/i);if(!s?.[1])return;const o=s[1].trim();if(!o)return;const n=e.match(/\bname\s*=\s*"([^"]+)"/i),i=n?.[1]?.trim();return{type:"resource_link",uri:`kimi-file://${o}`,...i?{name:i}:{},mimeType:this.guessMimeTypeFromFileName(i)??"application/octet-stream"}}guessMimeTypeFromFileName(t){if(!t)return;const e=t.trim().toLowerCase();return e?e.endsWith(".png")?"image/png":e.endsWith(".jpg")||e.endsWith(".jpeg")?"image/jpeg":e.endsWith(".webp")?"image/webp":e.endsWith(".gif")?"image/gif":e.endsWith(".bmp")?"image/bmp":e.endsWith(".svg")?"image/svg+xml":e.endsWith(".pdf")?"application/pdf":e.endsWith(".txt")?"text/plain":e.endsWith(".md")||e.endsWith(".markdown")?"text/markdown":e.endsWith(".json")?"application/json":e.endsWith(".csv")?"text/csv":void 0:void 0}resolveToolCallId(t,e,s){const o=asString(e.toolCallId)||asString(e.tool_call_id)||asString(e.callId)||asString(e.id);if(o){return t.toolCallIdsByIncomingId.get(o)||(t.toolCallIdsByIncomingId.set(o,o),o)}if("result"===s){const e=t.pendingGeneratedToolCallIds.shift();if(e)return e}t.nextGeneratedToolCallId+=1;const n=`tc_${t.gatewayRequestId}_${t.nextGeneratedToolCallId}`;return"start"===s&&t.pendingGeneratedToolCallIds.push(n),n}}