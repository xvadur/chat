import{closeSync,existsSync,openSync,readFileSync,readSync,statSync}from"node:fs";import os from"node:os";import path from"node:path";import{isPlainRecord as isRecord}from"../utils/json.js";import{asTrimmedNonEmptyString as asString}from"../utils/text.js";const LOCAL_HISTORY_LIMIT=200,LOCAL_HISTORY_TAIL_WINDOW_LINES=Math.max(6400,64),LOCAL_HISTORY_TAIL_CHUNK_BYTES=65536,LOCAL_HISTORY_TAIL_MAX_BYTES=1048576;export class AcpGatewayLocalSessionHistory{logger;agentId;constructor(t){this.logger=t.logger,this.agentId=t.agentId}readMessages(t,e){return this.readEntries(t,e).map(t=>({role:t.role,content:t.content,toolCallId:t.toolCallId,toolName:t.toolName,stopReason:t.stopReason,errorMessage:t.errorMessage}))}readEntries(t,e){const s=path.join(this.resolveOpenClawHome(),"agents",this.agentId,"sessions"),o=path.join(s,"sessions.json");if(!existsSync(o))return[];let r={};try{const t=readFileSync(o,"utf-8"),e=JSON.parse(t);if(!isRecord(e))return[];r=e}catch(t){return this.logger.warn(`[acp] failed to read local session store: ${String(t)}`),[]}const n=e??t,i=isRecord(r[n])?r[n]:void 0;if(!i)return[];const a=asString(i.sessionFile),l=asString(i.sessionId);if(!a&&!l)return[];const c=a??path.join(s,`${l}.jsonl`),g=path.isAbsolute(c)?c:path.join(s,c);if(!existsSync(g))return[];const S=[],p=this.readTailLines(g);for(const t of p){let e;try{e=JSON.parse(t)}catch{continue}if(!isRecord(e)||"message"!==asString(e.type)||!isRecord(e.message))continue;const s=e.message,o=asString(s.role);if("user"!==o&&"assistant"!==o&&"toolResult"!==o)continue;const r="number"==typeof e.ts&&Number.isFinite(e.ts)?e.ts:"number"==typeof s.timestamp&&Number.isFinite(s.timestamp)?s.timestamp:void 0;if(S.push({role:o,content:s.content,toolCallId:asString(s.toolCallId)??asString(s.tool_call_id),toolName:asString(s.toolName)??asString(s.tool_name),stopReason:asString(s.stopReason)??asString(s.stop_reason),errorMessage:asString(s.errorMessage)??asString(s.error_message)??(isRecord(s.error)?asString(s.error.message):void 0),timestamp:r}),S.length>=200)break}return S.reverse()}resolveOpenClawHome(){return asString(process.env.OPENCLAW_HOME)||path.join(os.homedir(),".openclaw")}readTailLines(t){let e,s=0;try{s=statSync(t).size}catch(t){return this.logger.warn(`[acp] failed to stat local session history file: ${String(t)}`),[]}if(s<=0)return[];try{e=openSync(t,"r");let o=s,r=1048576,n="";const i=[];for(;o>0&&r>0&&i.length<LOCAL_HISTORY_TAIL_WINDOW_LINES;){const t=Math.min(65536,o,r),s=o-t,a=Buffer.allocUnsafe(t),l=readSync(e,a,0,t,s);if(l<=0)break;o=s,r-=l;const c=(a.toString("utf-8",0,l)+n).split("\n");n=c.shift()??"";for(let t=c.length-1;t>=0;t-=1){const e=c[t]?.trim();if(e&&(i.push(e),i.length>=LOCAL_HISTORY_TAIL_WINDOW_LINES))break}}const a=n.trim();return a&&i.length<LOCAL_HISTORY_TAIL_WINDOW_LINES&&i.push(a),i}catch(t){return this.logger.warn(`[acp] failed to read local session history tail: ${String(t)}`),[]}finally{if(void 0!==e)try{closeSync(e)}catch{}}}}