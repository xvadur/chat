import{asTrimmedNonEmptyString as asString}from"../utils/text.js";const JSON_RPC_VERSION="2.0",META_DEBUG_INDEX_KEY="_debug_index";export class AcpGatewayTransport{logger;state;sendBridgeMessage;writeObsEvent;sanitizeObsMappingPayload;forwardThinkingToBridge;forwardToolCallsToBridge;constructor(e){this.logger=e.logger,this.state=e.state,this.sendBridgeMessage=e.sendBridgeMessage,this.writeObsEvent=e.writeObsEvent,this.sanitizeObsMappingPayload=e.sanitizeObsMappingPayload,this.forwardThinkingToBridge=e.forwardThinkingToBridge,this.forwardToolCallsToBridge=e.forwardToolCallsToBridge}sendSessionUpdate(e,s,t,o){if(!this.shouldForwardSessionUpdate(s)){const e=asString(s.sessionUpdate);return void("tool_call"!==e&&"tool_call_update"!==e||this.logger.debug?.(`[acp] skip tool session update sessionUpdate=${e} forwardToolCalls=${this.forwardToolCallsToBridge}`))}const r=this.resolveSessionUpdateMeta(t),a=this.state.nextMetaIndex(),i={[META_DEBUG_INDEX_KEY]:a,messageType:r.messageType};void 0!==r.timestamp&&(i.timestamp=r.timestamp),void 0!==r.requestId&&"cron"!==r.messageType&&(i.requestId=r.requestId);const n={jsonrpc:"2.0",method:"session/update",params:{sessionId:e,update:s,_meta:i}};if(void 0!==o?.before){const t=asString(s.sessionUpdate)??"unknown",i=this.detectObsProtocolError(o.before);this.writeObsEvent?.({component:"connector",domain:"mapping",name:"mapping.gateway_stream_to_session_update",severity:i?"warn":"info",protocolError:i,...void 0!==r.requestId?{requestId:String(r.requestId)}:{},sessionId:e,sessionKey:e,hop:o.hop??"openclaw_gateway->plugin",where:o.where??"AcpGatewayBridge.sendSessionUpdate",summary:`gateway stream -> ACP session/update:${t} (meta._debug_index=${a})`,before:this.sanitizeObsMappingPayload(o.before),after:this.sanitizeObsMappingPayload(n),payload:{sessionUpdate:t,metaIndex:a}})}this.sendBridgeMessage(n)}sendResult(e,s,t){const o=this.buildResponseMeta(e,t),r={jsonrpc:"2.0",id:e,result:this.attachResponseMetaToResult(s,o)};this.sendBridgeMessage(r)}sendError(e,s,t,o,r){const a=this.buildResponseMeta(e,r),i={jsonrpc:"2.0",id:e,error:{code:s,message:t,data:this.attachResponseMetaToErrorData(o,a)}};this.sendBridgeMessage(i),this.logger.warn(`[acp] request failed code=${s} message=${t}`)}buildResponseMeta(e,s){const t=this.state.nextMetaIndex();return{requestId:e,[META_DEBUG_INDEX_KEY]:t,...s?{sessionId:s}:{}}}attachResponseMetaToResult(e,s){if(isRecord(e)){const t=isRecord(e._meta)?e._meta:void 0;return{...e,_meta:{...t??{},...s}}}return null==e?{_meta:s}:{value:e,_meta:s}}attachResponseMetaToErrorData(e,s){if(isRecord(e)){const t=isRecord(e._meta)?e._meta:void 0;return{...e,_meta:{...t??{},...s}}}return void 0===e?{_meta:s}:{value:e,_meta:s}}resolveSessionUpdateMeta(e){if(void 0===e)return{requestId:void 0,messageType:"normal"};if("string"==typeof e||"number"==typeof e)return{requestId:e,messageType:"normal"};const s=this.resolveMetaTimestamp(e.timestamp);return{requestId:e.requestId,messageType:"cron"===e.messageType?"cron":"normal",timestamp:s}}resolveMetaTimestamp(e){if("number"==typeof e&&Number.isFinite(e))return e;if("string"==typeof e){const s=Date.parse(e);if(Number.isFinite(s))return s}}shouldForwardSessionUpdate(e){const s=asString(e.sessionUpdate);return!s||!(!this.forwardThinkingToBridge&&"agent_thought_chunk"===s)&&!!(this.forwardToolCallsToBridge||"tool_call"!==s&&"tool_call_update"!==s)}detectObsProtocolError(e){if(!isRecord(e))return!1;if(Object.prototype.hasOwnProperty.call(e,"error")&&void 0!==e.error)return!0;if(!1===e.ok)return!0;const s=isRecord(e.payload)?e.payload:void 0;return!(!s||(!Object.prototype.hasOwnProperty.call(s,"error")||void 0===s.error)&&!1!==s.ok)}}const isRecord=e=>"object"==typeof e&&null!==e&&!Array.isArray(e);