import{randomUUID}from"node:crypto";import{mkdir,readFile,rename,stat,unlink,writeFile,readdir}from"node:fs/promises";import os from"node:os";import path from"node:path";import{isPlainRecord as isRecord}from"./utils/json.js";export const KIMI_UPLOAD_TOOL_RESULT_TTL_MS=864e5;const KIMI_UPLOAD_TOOL_RESULT_CACHE_DIR=path.join(os.homedir(),".kimi","kimi-claw","upload_meta"),KIMI_UPLOAD_TOOL_RESULT_CACHE_VERSION=1,safeToolCallId=t=>t.replace(/[^a-zA-Z0-9._-]/g,"_"),getCachePath=t=>path.join(KIMI_UPLOAD_TOOL_RESULT_CACHE_DIR,`${safeToolCallId(t)}.json`),safeUnlink=async t=>{try{await unlink(t)}catch{}},isUploadPayload=t=>isRecord(t)&&(!0===t.ok||!1===t.ok||"files"in t||"content"in t&&Array.isArray(t.content)),pickKimiUploadPayload=t=>{if(!isRecord(t))return;const o=t.output;if(isUploadPayload(o))return{output:o};if(isRecord(o)){if(isUploadPayload(o.output))return{output:o.output};if(isUploadPayload(o.result))return{output:o.result};if(isUploadPayload(o.details))return{output:o.details}}const a=t.result;if(isUploadPayload(a))return{output:a};if(isRecord(a)){if(isUploadPayload(a.output))return{output:a.output};if(isUploadPayload(a.result))return{output:a.result};if(isUploadPayload(a.details))return{output:a.details}}const e=t.details;if(isUploadPayload(e))return{output:e};if(isRecord(e)){if(isUploadPayload(e.output))return{output:e.output};if(isUploadPayload(e.result))return{output:e.result};if(isUploadPayload(e.details))return{output:e.details}}return Array.isArray(t.content)&&t.content.length>0?{content:t.content}:isUploadPayload(t)?{output:t}:void 0},normalizeCachedResult=t=>{const o=pickKimiUploadPayload(t);if(o)return isRecord(o)?o:void 0};export async function writeKimiUploadToolResult(t,o,a){await mkdir(KIMI_UPLOAD_TOOL_RESULT_CACHE_DIR,{recursive:!0,mode:448});const e=getCachePath(t),i={version:1,createdAt:Date.now(),toolCallId:t,toolName:o,result:a},r=`${e}.${randomUUID()}.tmp`;await writeFile(r,JSON.stringify(i),{encoding:"utf8",mode:384}),await rename(r,e)}export async function readKimiUploadToolResult(t){const o=getCachePath(t);let a;try{a=await stat(o)}catch{return}const e=Date.now();if(e-a.mtimeMs>=864e5)return void await safeUnlink(o);let i,r;try{i=await readFile(o,"utf8")}catch{return}try{r=JSON.parse(i)}catch{return void await safeUnlink(o)}if(isRecord(r)&&1===r.version&&!("number"!=typeof r.createdAt||r.createdAt<=0)&&"string"==typeof r.toolCallId&&0!==r.toolCallId.length&&"string"==typeof r.toolName&&0!==r.toolName.length){if(!(e-r.createdAt>=864e5))return normalizeCachedResult(r.result);await safeUnlink(o)}}export async function cleanupKimiUploadToolResultCache(){let t;try{t=await readdir(KIMI_UPLOAD_TOOL_RESULT_CACHE_DIR,{withFileTypes:!0})}catch{return 0}const o=Date.now();let a=0;for(const e of t){if(!e.isFile())continue;if(!e.name.endsWith(".json")&&!e.name.includes(".tmp"))continue;const t=path.join(KIMI_UPLOAD_TOOL_RESULT_CACHE_DIR,e.name);let i;try{i=await stat(t)}catch{continue}if(!(o-i.mtimeMs<864e5))try{await unlink(t),a+=1}catch{}}return a}