import path from"node:path";import{mirrorOpenClawConfigToLocalDir,resolveConnectorConfigWithMeta}from"./config.js";import{createObsEventWriter}from"./observability.js";import{resolvePluginVersion}from"./plugin-version.js";import{buildLogger}from"./service/logger.js";import{createAcpModeClients}from"./service/mode-acp.js";import{createBridgeModeClients}from"./service/mode-bridge.js";import{createTerminalWebSocketService}from"./service/terminal-websocket.js";import{detachManualReconnectSignal,MANUAL_RECONNECT_SIGNAL,registerManualReconnectSignal}from"./service/reconnect-signal.js";import{resolveObsEventFilePath}from"./service/obs-file.js";import{buildAllTrace,buildForwardTrace,buildReplyTrace}from"./service/trace.js";import{normalizeTraceFilter}from"./trace-utils.js";const CONNECT_VERSION=resolvePluginVersion();export function createConnectorService(e){let o=null,r=null,i=null;const l={handler:null};let n=!0;const t=()=>{n=!0,detachManualReconnectSignal(l),o?.stop(),r?.stop(),i?.stop(),o=null,r=null,i=null};return{start:a=>{t(),n=!1;const s=resolveConnectorConfigWithMeta({pluginConfig:e.pluginConfig,openclawConfig:a.config}),c=s.config,g=buildLogger(e.logger,c.log.verbose),d=resolveObsEventFilePath(c),p=normalizeTraceFilter({requestId:c.log.requestIdFilter,sessionId:c.log.sessionIdFilter}),f={terminalPayloadMode:c.log.terminalPayloadMode,terminalArtifactDir:c.log.terminalArtifactDir},m=c.log.enabled?buildAllTrace(c.log.allFile,g,p):e=>{},u=c.log.enabled?(()=>{const e=path.resolve(c.log.allFile),o=path.resolve(c.log.forwardFile)!==e;return buildForwardTrace(c.log.forwardFile,g,p,o?m:void 0,f)})():(e,o)=>{},v=c.log.enabled?(()=>{const e=path.resolve(c.log.allFile),o=path.resolve(c.log.replyFile)!==e;return buildReplyTrace(c.log.replyFile,g,p,o?m:void 0,f)})():(e,o)=>{};c.log.enabled?(g.info(`[trace] all trace file=${c.log.allFile}`),g.info(`[trace] forward trace file=${c.log.forwardFile}`),g.info(`[trace] reply trace file=${c.log.replyFile}`),g.info(`[trace] ws observability file=${c.log.wsObsFile}`),(p.requestId||p.sessionId)&&g.info(`[trace] filter requestId=${p.requestId??"*"} sessionId=${p.sessionId??"*"}`)):g.info("[trace] file logging disabled (log.enabled=false)");const b=c.log.enabled?createObsEventWriter({filePath:d,logger:g,redaction:{bridgeToken:c.bridge.token,gatewayToken:c.gateway.token}}):()=>{};b({component:"connector",domain:"lifecycle",name:"lifecycle.startup",severity:"info",payload:{pluginVersion:CONNECT_VERSION,pid:process.pid,nodeVersion:process.version,cwd:process.cwd(),traceFiles:{forward:path.resolve(c.log.forwardFile),reply:path.resolve(c.log.replyFile),all:path.resolve(c.log.allFile),wsObs:path.resolve(c.log.wsObsFile),obsEventSink:path.resolve(d)}}}),b({component:"connector",domain:"config",name:"config.resolved",severity:"info",payload:{config:c,sources:s.sources,openclawConfigPath:s.openclawConfigPath}});for(const e of s.validation)b({component:"connector",domain:"config",name:"config.validation",severity:"error"===e.severity?"error":"warn",summary:e.message,error:{code:e.code,message:e.message,nextSteps:e.nextSteps}});if(s.validation.find(e=>"CONFIG_BRIDGE_USER_ID_MISSING"===e.code))return void g.error("bridge.userId missing; set plugins.entries.kimi-claw.config.bridge.userId in ~/.openclaw/openclaw.json");if("acp"===c.bridge.mode){const e=createAcpModeClients({cfg:c,logger:g,connectVersion:CONNECT_VERSION,traceForward:u,traceReply:v,traceAll:m,writeObsEvent:b,isStopped:()=>n});o=e.bridgeClient,r=e.gatewayClient,e.terminalHandler&&(a.terminalHandler=e.terminalHandler)}else{const e=createBridgeModeClients({cfg:c,logger:g,connectVersion:CONNECT_VERSION,traceForward:u,writeObsEvent:b});o=e.bridgeClient,r=e.gatewayClient}i=createTerminalWebSocketService({logger:g,config:{...c.bridge.terminalWs??{},idleTimeoutMs:c.bridge.shell.idleTimeoutMs,maxDurationMs:c.bridge.shell.maxDurationMs},defaultShell:c.bridge.shell.defaultShell}),registerManualReconnectSignal({state:l,logger:g,onReconnect:()=>{n||(g.warn(`manual reconnect signal received signal=${MANUAL_RECONNECT_SIGNAL}`),o?.stop(),r?.stop(),o?.start(),r?.start())}}),o.start(),r?.start(),i.start();const w=mirrorOpenClawConfigToLocalDir({openclawConfig:a.config});w.copied?g.info(`[config] mirrored openclaw config to ${w.destinationPath}`):g.warn(`[config] openclaw config mirror skipped reason=${w.reason??"unknown"} path=${w.destinationPath} error=${w.error??"none"}`)},stop:t,get stopped(){return n}}}